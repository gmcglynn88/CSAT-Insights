<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{ --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D; --pill:#e9f6f0;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    body{font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:start}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}
    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    table{width:100%;border-collapse:collapse;margin-top:12px;border:1px solid var(--border-color);border-radius:6px;overflow:hidden}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border-color);vertical-align:top}
    th{background-color:var(--primary-color);color:white;font-weight:600}
    tr:hover{background-color:rgba(99,171,143,.05)}
    .table-container{overflow-x:auto;border:1px solid var(--border-color);border-radius:6px;padding:1px;margin-top:10px}

    .checkbox-dropdown{position:relative;min-width:220px;width:100%}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer;width:100%;box-sizing:border-box}
    .cd-trigger .label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50;flex-shrink:0;margin-left:8px}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none;box-sizing:border-box}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px;width:100%;box-sizing:border-box}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer;white-space:nowrap}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:#6c757d;display:flex;justify-content:space-between}

    .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    .comment-bubble{background:#f8f9fa;border:1px solid #dee2e6;border-radius:12px;padding:8px 12px;margin-top:4px;font-size:12px;color:#6c757d}
    
    .rating-indicator{display:inline-block;width:20px;height:20px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .rating-5{background-color:#22c55e}
    .rating-4{background-color:#86efac}
    .rating-3{background-color:#f59e0b}
    .rating-2{background-color:#fdba74}
    .rating-1{background-color:#ef4444}
    
    .badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;border:1px solid var(--border-color);background:#fff}
    .badge-excellent{color:#14532d;background:#dcfce7;border-color:#bbf7d0}
    .badge-good{color:#166534;background:#bbf7d0;border-color:#86efac}
    .badge-fair{color:#f59e0b;background:#fef3c7;border-color:#fde68a}
    .badge-poor{color:#d97706;background:#fed7aa;border-color:#fdba74}
    .badge-very-poor{color:#b4231a;background:#fee2e2;border-color:#fecaca}
    
    .expandable-row { cursor: pointer; }
    .expandable-content { display: none; padding: 20px; background: var(--light-bg); border-top: 1px solid var(--border-color); }
    .expand-icon { margin-right: 8px; transition: transform 0.3s; }
    .expanded .expand-icon { transform: rotate(90deg); }
    
    .survey-details { margin-top: 10px; padding-left: 20px; border-left: 3px solid var(--primary-color); }
    .survey-question { margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid var(--border-color); }
    
    .stat-card { background: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .stat-card .value { font-size: 32px; font-weight: bold; color: var(--primary-color); }
    .stat-card .label { font-size: 14px; color: var(--text-light); margin-top: 8px; }
    
    .no-data { text-align: center; padding: 40px; color: var(--text-light); }
    
    .debug-info { background: #f1f3f5; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin-top: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    
    .api-test-button { background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; }
    .api-test-button:hover { background: #4338ca; }
    
    .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #63AB8F; background: #f8f9fa; }
    .log-error { border-left-color: #ef4444; background: #fee2e2; }
    .log-success { border-left-color: #22c55e; background: #dcfce7; }
  </style>
</head>
<body>
  <div id="authCard" class="card" style="display:block;">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">CSAT Survey Viewer</h2>
      <div class="controls">
        <div>
          <label for="fromDate">From Date</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label for="toDate">To Date</label>
          <input id="toDate" type="date">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadBtn" class="full-width-btn">
            <span class="loading-spinner" style="display:none"></span>
            <span class="btn-text">Load Surveys</span>
          </button>
        </div>
      </div>
      <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;">
        <h4 style="margin-top: 0; color: #0369a1;">Test Specific Conversation</h4>
        <p style="margin: 5px 0; font-size: 14px;">Test a known conversation that has surveys:</p>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="text" id="testConversationId" placeholder="Enter Conversation ID" style="flex: 1; padding: 8px;" value="66b7b3b8-a065-4ecf-85f5-2b24bf2493a1">
          <button id="testApiBtn" class="api-test-button">Test API Call</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="section-title">Survey Responses</h2>
      <div id="surveysContainer" class="no-data">Click "Load Surveys" or test a specific conversation</div>
      <div id="debugContainer" style="display:block; margin-top: 20px;">
        <h3>API Log</h3>
        <div id="apiLog"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Configuration =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const config = { REGION: 'mypurecloud.ie' };
    const redirectUri = 'https://gmcglynn88.github.io/CSAT-Insights/';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&state=csat`;

    const state = {
      accessToken: null,
      surveys: [],
      apiLog: []
    };

    // ===== Helper Functions =====
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function msg(html,type='info'){
      const box=document.getElementById('messageContainer');
      box.innerHTML=`<div class="${type}-message">${html}</div>`;
      box.style.display='block';
      if(type==='success'){ setTimeout(()=>box.style.display='none',5000); }
    }

    function setLoading(button,isLoading){
      const spinner=button.querySelector('.loading-spinner');
      const text=button.querySelector('.btn-text');
      if(isLoading){ 
        spinner.style.display='inline-block'; 
        text.textContent='Loading...'; 
        button.disabled=true; 
      } else { 
        spinner.style.display='none'; 
        text.textContent='Load Surveys'; 
        button.disabled=false; 
      }
    }

    function safeGet(o,p,def=null){ 
      try{ 
        return p.split('.').reduce((x,k)=>(x && k in x)?x[k]:undefined ,o) ?? def; 
      } catch{ 
        return def; 
      } 
    }

    function toUKDate(d){ 
      const dt=new Date(d); 
      return dt.toLocaleDateString('en-GB'); 
    }
    
    function toDateTime(d){ 
      const dt=new Date(d); 
      return dt.toLocaleString('en-GB'); 
    }

    function getRatingLabel(score){
      if(score >= 9) return {label: 'Excellent', class: 'excellent', badge: 'badge-excellent'};
      if(score >= 7) return {label: 'Good', class: 'good', badge: 'badge-good'};
      if(score >= 5) return {label: 'Fair', class: 'fair', badge: 'badge-fair'};
      if(score >= 3) return {label: 'Poor', class: 'poor', badge: 'badge-poor'};
      return {label: 'Very Poor', class: 'very-poor', badge: 'badge-very-poor'};
    }

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = {
        timestamp,
        message,
        type
      };
      
      state.apiLog.unshift(logEntry); // Add to beginning for reverse chronological order
      
      // Keep only last 50 entries
      if (state.apiLog.length > 50) {
        state.apiLog = state.apiLog.slice(0, 50);
      }
      
      // Update log display
      const logContainer = document.getElementById('apiLog');
      let logHtml = '';
      
      state.apiLog.forEach(entry => {
        logHtml += `<div class="log-entry ${entry.type === 'error' ? 'log-error' : entry.type === 'success' ? 'log-success' : ''}">
          <strong>${entry.timestamp}:</strong> ${entry.message}
        </div>`;
      });
      
      logContainer.innerHTML = logHtml;
    }

    // ===== OAuth Flow =====
    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM loaded, starting OAuth flow...');

      const rawHash = (window.location.hash || '').replace(/^#/, '');
      const params = new URLSearchParams(rawHash);

      // OAuth error
      const oauthError = params.get('error');
      if (oauthError) {
        const desc = decodeURIComponent(params.get('error_description') || '');
        console.error('OAuth error:', oauthError, desc);
        history.replaceState(null, document.title, window.location.pathname + window.location.search);
        sessionStorage.removeItem('purecloud_csat_token');
        sessionStorage.removeItem('purecloud_csat_token_exp');

        document.getElementById('auth-message').textContent = 'Sign-in failed. Please refresh the page to try again.';
        document.getElementById('auth-message').className = 'error-message';
        return;
      }

      // Token in hash
      const tokenFromHash = params.get('access_token');
      if (tokenFromHash) {
        console.log('Token found in hash');
        const expiresIn = parseInt(params.get('expires_in') || '0', 10);
        const expAt = expiresIn ? Date.now() + (expiresIn - 60) * 1000 : 0;
        sessionStorage.setItem('purecloud_csat_token', tokenFromHash);
        if (expAt) sessionStorage.setItem('purecloud_csat_token_exp', String(expAt));
        history.replaceState(null, document.title, window.location.pathname + window.location.search);
        startApp(tokenFromHash);
        return;
      }

      // Token from session
      const tokenFromSession = sessionStorage.getItem('purecloud_csat_token');
      const exp = parseInt(sessionStorage.getItem('purecloud_csat_token_exp') || '0', 10);
      if (tokenFromSession && (!exp || Date.now() < exp)) {
        console.log('Token found in session storage');
        startApp(tokenFromSession);
        return;
      }

      // No token yet - redirect to OAuth
      console.log('No token found, redirecting to OAuth');
      document.getElementById('auth-message').textContent = 'Redirecting to Genesys Cloud for authentication...';
      setTimeout(function(){ window.location.href = oauthUrl; }, 200);
    });

    // ===== App Initialization =====
    function startApp(token){
      console.log('Starting app with token');
      state.accessToken = token;
      
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('auth-message').className = 'success-message';
      
      setTimeout(() => { 
        document.getElementById('authCard').style.display = 'none'; 
        document.getElementById('appContent').style.display = 'block';
      }, 800);

      // Set button handlers
      document.getElementById('loadBtn').onclick = loadSurveys;
      document.getElementById('testApiBtn').onclick = testSpecificConversation;

      // Set default dates (last 7 days)
      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 7);
      
      document.getElementById('fromDate').value = sevenDaysAgo.toISOString().split('T')[0];
      document.getElementById('toDate').value = today.toISOString().split('T')[0];

      addLog('App initialized successfully', 'success');
    }

    // ===== API Functions =====
    async function makeApiCall(url, options = {}) {
      const startTime = Date.now();
      addLog(`Making API call to: ${url}`);
      
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Authorization': 'Bearer ' + state.accessToken,
            'Content-Type': 'application/json',
            ...(options.headers || {})
          }
        });
        
        const endTime = Date.now();
        const duration = endTime - startTime;
        
        addLog(`Response: ${response.status} ${response.statusText} (${duration}ms)`);
        
        if (response.ok) {
          if (response.status === 204) {
            return null;
          }
          const data = await response.json();
          return data;
        } else {
          const errorText = await response.text();
          addLog(`Error ${response.status}: ${errorText}`, 'error');
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        addLog(`Fetch error: ${error.message}`, 'error');
        throw error;
      }
    }

    // ===== Test Specific Conversation =====
    async function testSpecificConversation() {
      const conversationId = document.getElementById('testConversationId').value.trim();
      if (!conversationId) {
        msg('Please enter a conversation ID', 'error');
        return;
      }
      
      const btn = document.getElementById('testApiBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Testing...';
      btn.disabled = true;
      
      try {
        addLog(`=== Testing survey API for conversation: ${conversationId} ===`);
        
        // Build the exact URL as shown in your example
        const url = `https://api.${config.REGION}/api/v2/quality/conversations/${conversationId}/surveys`;
        
        addLog(`GET ${url}`);
        
        const data = await makeApiCall(url, { method: 'GET' });
        
        if (data) {
          addLog(`API Response received`, 'success');
          
          // FIXED: Handle both array response and entities wrapper
          const surveysArray = Array.isArray(data) ? data : (data.entities || []);
          
          if (surveysArray.length > 0) {
            addLog(`Found ${surveysArray.length} survey(s)`, 'success');
            
            // Parse and display each survey
            let html = `
              <div class="stat-card">
                <div class="value">${surveysArray.length}</div>
                <div class="label">Surveys Found</div>
              </div>
              <h3>Surveys for Conversation: ${conversationId}</h3>
            `;
            
            surveysArray.forEach((survey, index) => {
              const score = survey.totalScore || 0;
              const npsScore = survey.npsScore || 0;
              const rating = getRatingLabel(score / 10); // Convert from 0-100 to 0-10 scale
              const roundedScore = Math.round(score / 10);
              
              html += `
                <div class="survey-details" style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;">
                  <h4>Survey ${index + 1} - ${survey.status || 'Unknown Status'}</h4>
                  <div><strong>Survey ID:</strong> ${survey.id}</div>
                  <div><strong>Status:</strong> ${survey.status}</div>
                  <div><strong>Total Score:</strong> ${score}%</div>
                  <div><strong>NPS Score:</strong> ${npsScore}</div>
                  <div><strong>Completed Date:</strong> ${survey.completedDate || 'N/A'}</div>
                  <div><strong>Survey Type:</strong> ${survey.surveyType || 'Unknown'}</div>
                  ${survey.surveyForm && survey.surveyForm.name ? `<div><strong>Survey Form:</strong> ${survey.surveyForm.name}</div>` : ''}
                  
                  <div style="margin-top: 10px;">
                    <span class="rating-indicator rating-${roundedScore}"></span>
                    <span class="badge ${rating.badge}">${(score/10).toFixed(1)} - ${rating.label}</span>
                  </div>
                  
                  ${survey.answers && survey.answers.questionGroupScores ? `
                    <h5 style="margin-top: 15px;">Question Responses:</h5>
                    ${survey.answers.questionGroupScores.map((group, gIndex) => `
                      <div class="survey-question">
                        <div><strong>Question Group ${gIndex + 1}:</strong></div>
                        ${group.questionScores ? group.questionScores.map((q, qIndex) => `
                          <div style="margin-left: 15px; margin-top: 5px;">
                            <div><strong>Question ${qIndex + 1}:</strong> ${q.questionId || 'Unknown'}</div>
                            <div><strong>Score:</strong> ${q.score || q.npsScore || 0}</div>
                          </div>
                        `).join('') : '<div>No question scores</div>'}
                      </div>
                    `).join('')}
                  ` : '<div class="muted">No question details available</div>'}
                </div>
              `;
            });
            
            document.getElementById('surveysContainer').innerHTML = html;
            msg(`Found ${surveysArray.length} surveys for conversation ${conversationId}`, 'success');
          } else {
            addLog('No surveys found in response', 'info');
            const container = document.getElementById('surveysContainer');
            container.innerHTML = `
              <div class="stat-card">
                <div class="value">0</div>
                <div class="label">Surveys Found</div>
              </div>
              <div class="muted">No surveys found for conversation ${conversationId}</div>
              <div class="debug-info">
                <pre>${JSON.stringify(data, null, 2)}</pre>
              </div>
            `;
            msg(`No surveys found for conversation ${conversationId}`, 'info');
          }
        } else {
          addLog('Empty response received', 'info');
          const container = document.getElementById('surveysContainer');
          container.innerHTML = `
            <div class="stat-card">
              <div class="value">0</div>
              <div class="label">Surveys Found</div>
            </div>
            <div class="muted">Empty response for conversation ${conversationId}</div>
          `;
          msg(`Empty response for conversation ${conversationId}`, 'info');
        }
        
      } catch (error) {
        console.error('Test API error:', error);
        msg(`Test failed: ${error.message}`, 'error');
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // ===== Main Survey Loading =====
    async function loadSurveys(){
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      
      if(!fromDate || !toDate){
        msg('Please select both From and To dates.', 'error');
        return;
      }
      
      // Clear previous surveys
      state.surveys = [];
      
      const start = new Date(fromDate + 'T00:00:00');
      const end = new Date(toDate + 'T23:59:59');
      
      addLog(`Loading surveys from ${fromDate} to ${toDate}`);
      
      const btn = document.getElementById('loadBtn'); 
      setLoading(btn, true); 
      msg('Loading conversations and surveys...', 'info');
      
      try {
        // First, get conversations using the analytics API
        const conversations = await fetchConversations(start, end);
        addLog(`Found ${conversations.length} conversations`, 'success');
        
        if (conversations.length === 0) {
          renderSurveys();
          msg('No conversations found for the selected date range', 'info');
          return;
        }
        
        // Get surveys for these conversations
        const surveys = await fetchSurveysForConversations(conversations);
        addLog(`Found ${surveys.length} surveys`, 'success');
        
        state.surveys = surveys;
        
        renderSurveys();
        msg(`Loaded ${surveys.length} surveys from ${conversations.length} conversations.`, 'success');
      } catch(e) { 
        console.error('Error loading surveys:', e); 
        msg('Failed to load surveys: ' + e.message, 'error'); 
      } finally { 
        setLoading(btn, false); 
      }
    }

    // Fetch conversations using analytics conversations aggregates API
    async function fetchConversations(start, end){
      const url = `https://api.${config.REGION}/api/v2/analytics/conversations/aggregates/query`;
      
      // Build the request body
      const body = {
        "interval": `${start.toISOString()}/${end.toISOString()}`,
        "granularity": "P1D",
        "groupBy": ["conversationId"],
        "metrics": ["nOffered"],
        "flattenMultivaluedDimensions": false
      };
      
      try {
        addLog('Fetching conversations...');
        const data = await makeApiCall(url, {
          method: 'POST',
          body: JSON.stringify(body)
        });
        
        const conversations = [];
        if(data && data.results && data.results.length > 0){
          data.results.forEach(result => {
            if(result.group && result.group.conversationId){
              conversations.push({
                conversationId: result.group.conversationId
              });
            }
          });
          
          // Remove duplicates
          const uniqueConversations = Array.from(
            new Map(conversations.map(c => [c.conversationId, c])).values()
          );
          
          return uniqueConversations;
        }
        
        return [];
      } catch (error) {
        console.error('Error fetching conversations:', error);
        throw error;
      }
    }

    // Fetch surveys for conversations - FIXED VERSION
    async function fetchSurveysForConversations(conversations){
      if(!conversations || conversations.length === 0) {
        return [];
      }
      
      const allSurveys = [];
      
      // Process conversations in batches
      const batchSize = 10;
      for(let i = 0; i < conversations.length; i += batchSize){
        const batch = conversations.slice(i, i + batchSize);
        addLog(`Processing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(conversations.length/batchSize)}`);
        
        // Process each conversation in the batch
        for (const conversation of batch) {
          try {
            const url = `https://api.${config.REGION}/api/v2/quality/conversations/${conversation.conversationId}/surveys`;
            
            addLog(`Fetching surveys for: ${conversation.conversationId}`);
            const surveysData = await makeApiCall(url, { method: 'GET' });
            
            // FIXED: Handle both array response and entities wrapper
            const surveysArray = Array.isArray(surveysData) ? surveysData : (surveysData?.entities || []);
            
            if(surveysArray.length > 0){
              addLog(`Found ${surveysArray.length} survey(s) for ${conversation.conversationId}`, 'success');
              
              // Process each survey
              surveysArray.forEach(survey => {
                if (survey.status === "Finished") {
                  allSurveys.push({
                    conversationId: conversation.conversationId,
                    surveyId: survey.id,
                    score: survey.totalScore || 0,
                    npsScore: survey.npsScore || 0,
                    submittedDate: survey.completedDate,
                    status: survey.status,
                    surveyType: survey.surveyType || 'Unknown',
                    surveyFormName: survey.surveyForm?.name || 'Unknown',
                    answers: survey.answers,
                    agentId: survey.agent?.id,
                    agentTeamId: survey.agentTeam?.id,
                    queueId: survey.queue?.id
                  });
                } else {
                  addLog(`Skipping survey ${survey.id} with status: ${survey.status}`, 'info');
                }
              });
            } else {
              addLog(`No surveys found for ${conversation.conversationId}`, 'info');
            }
          } catch (error) {
            // Continue with next conversation even if one fails
            console.error(`Error fetching surveys for ${conversation.conversationId}:`, error);
            addLog(`Error fetching surveys for ${conversation.conversationId}: ${error.message}`, 'error');
          }
        }
        
        // Small delay between batches
        if(i + batchSize < conversations.length){
          await sleep(500);
        }
      }
      
      addLog(`Total completed surveys found: ${allSurveys.length}`, 'success');
      return allSurveys;
    }

    // ===== Render Surveys =====
    function renderSurveys(){
      const container = document.getElementById('surveysContainer');
      
      if(!state.surveys || state.surveys.length === 0){
        container.innerHTML = `
          <div class="stat-card">
            <div class="value">0</div>
            <div class="label">Surveys Found</div>
          </div>
          <div class="muted">No surveys found for the selected criteria.</div>
        `;
        return;
      }
      
      // Calculate statistics
      const totalSurveys = state.surveys.length;
      const totalScore = state.surveys.reduce((sum, s) => sum + (s.score || 0), 0);
      const avgScore = totalSurveys > 0 ? totalScore / totalSurveys : 0;
      
      let html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
          <div class="stat-card">
            <div class="value">${totalSurveys}</div>
            <div class="label">Surveys Found</div>
          </div>
          <div class="stat-card">
            <div class="value">${(avgScore/10).toFixed(1)}</div>
            <div class="label">Average Score (0-10)</div>
          </div>
          <div class="stat-card">
            <div class="value">${avgScore.toFixed(1)}%</div>
            <div class="label">Average Score %</div>
          </div>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Conversation ID</th>
                <th>Date</th>
                <th>Survey Type</th>
                <th>Score</th>
                <th>NPS</th>
                <th>Status</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      let rowIndex = 0;
      
      // Sort surveys by date (newest first)
      const sortedSurveys = [...state.surveys].sort((a, b) => {
        const dateA = a.submittedDate ? new Date(a.submittedDate) : new Date(0);
        const dateB = b.submittedDate ? new Date(b.submittedDate) : new Date(0);
        return dateB - dateA;
      });
      
      sortedSurveys.forEach((survey, surveyIndex) => {
        const date = survey.submittedDate ? toDateTime(survey.submittedDate) : 'Unknown date';
        const score = survey.score || 0; // This is 0-100 scale
        const npsScore = survey.npsScore || 0;
        const rating = getRatingLabel(score / 10); // Convert to 0-10 scale for rating
        const roundedScore = Math.round(score / 10);
        
        html += `
          <tr class="expandable-row" onclick="toggleSurveyRow(${rowIndex})">
            <td><code style="font-size: 11px;">${survey.conversationId}</code></td>
            <td>${date}</td>
            <td>${survey.surveyType || 'Survey'}</td>
            <td>
              <span class="rating-indicator rating-${roundedScore}"></span>
              <span class="badge ${rating.badge}">${(score/10).toFixed(1)} - ${rating.label}</span>
              <div style="font-size: 11px; color: #6c757d;">${score}%</div>
            </td>
            <td>${npsScore}</td>
            <td>${survey.status || 'Unknown'}</td>
            <td><span class="expand-icon">▶</span> Click to expand</td>
          </tr>
          <tr id="survey-row-${rowIndex}" class="expandable-content">
            <td colspan="7">
              <div class="survey-details">
                <div><strong>Conversation ID:</strong> ${survey.conversationId}</div>
                <div><strong>Survey ID:</strong> ${survey.surveyId}</div>
                <div><strong>Survey Type:</strong> ${survey.surveyType || 'Unknown'}</div>
                <div><strong>Survey Form:</strong> ${survey.surveyFormName || 'Unknown'}</div>
                <div><strong>Status:</strong> ${survey.status || 'Unknown'}</div>
                <div><strong>Score:</strong> ${score}% (${(score/10).toFixed(1)}/10)</div>
                <div><strong>NPS Score:</strong> ${npsScore}</div>
                ${survey.answers && survey.answers.questionGroupScores ? `
                  <h5>Question Responses:</h5>
                  ${survey.answers.questionGroupScores.map((group, gIndex) => `
                    <div class="survey-question">
                      <div><strong>Question Group ${gIndex + 1}:</strong></div>
                      ${group.questionScores ? group.questionScores.map((q, qIndex) => `
                        <div style="margin-left: 15px; margin-top: 5px;">
                          <div><strong>Question ${qIndex + 1}:</strong> ${q.questionId || 'Unknown'}</div>
                          <div><strong>Score:</strong> ${q.score || q.npsScore || 0}</div>
                        </div>
                      `).join('') : '<div>No question scores</div>'}
                    </div>
                  `).join('')}
                ` : '<div class="muted">No question details available</div>'}
              </div>
            </td>
          </tr>
        `;
        
        rowIndex++;
      });
      
      html += `
            </tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px">
          Showing ${sortedSurveys.length} surveys
        </div>
      `;
      
      container.innerHTML = html;
    }

    // ===== Global Functions for HTML =====
    window.toggleSurveyRow = function(index) {
      const row = document.getElementById(`survey-row-${index}`);
      const icon = document.querySelector(`#survey-row-${index}`).previousElementSibling.querySelector('.expand-icon');
      
      if (row.style.display === 'none' || !row.style.display) {
        row.style.display = 'table-row';
        icon.textContent = '▼';
        icon.classList.add('expanded');
      } else {
        row.style.display = 'none';
        icon.textContent = '▶';
        icon.classList.remove('expanded');
      }
    };
  </script>
</body>
</html>
