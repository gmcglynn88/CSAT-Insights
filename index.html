<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Survey Viewer</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#fafafa; }
  .group { margin-bottom: 25px; padding: 15px; border-radius: 8px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
  .question { margin-bottom: 10px; }
  .q-text { font-weight: bold; }
  .q-score { color: #1a7f37; font-weight: bold; }
</style>
</head>
<body>

<h2>Survey Results</h2>
<div id="surveyContainer">Loadingâ€¦</div>

<script>
// Assumes oauth and API functions already exist

async function run() {
    // Replace these with your live API calls
    const qualityResponse = window.QUALITY_RESPONSE;
    const analyticsResponse = window.ANALYTICS_RESPONSE;

    const survey = qualityResponse[0];
    const form = survey.surveyForm;

    const formQuestions = {};
    form.questionGroups.forEach(group => {
      group.questions.forEach(q => {
        formQuestions[q.id] = {
          groupId: group.id,
          groupName: group.name,
          questionId: q.id,
          text: q.text,
          type: q.type,
          answerOptions: q.answerOptions || []
        };
      });
    });

    const qualityAnswers = {};
    survey.answers.questionGroupScores.forEach(g => {
      g.questionScores.forEach(qs => {
        qualityAnswers[qs.questionId] = {
          score: qs.score ?? qs.npsScore ?? null,
          answerId: qs.answerId || null,
          groupId: g.questionGroupId
        };
      });
    });

    const analyticsAnswers = {};
    analyticsResponse.results.forEach(result => {
      const qId = result.group.surveyQuestionId;
      const metrics = result.data[0].metrics;
      const qm = metrics.find(m => m.metric === "oSurveyQuestionScore");
      if (qm) analyticsAnswers[qId] = { score: qm.stats.sum };
    });

    const merged = {};
    Object.values(formQuestions).forEach(q => {
      const analytics = analyticsAnswers[q.questionId];
      const quality = qualityAnswers[q.questionId];
      merged[q.questionId] = {
        groupName: q.groupName,
        questionId: q.questionId,
        text: q.text,
        score: analytics?.score ?? quality?.score ?? null,
      };
    });

    const container = document.getElementById("surveyContainer");

    const groups = {};
    Object.values(merged).forEach(q => {
      if (!groups[q.groupName]) groups[q.groupName] = [];
      groups[q.groupName].push(q);
    });

    container.innerHTML = Object.keys(groups).map(g => {
      return `
        <div class="group">
          <h3>${g}</h3>
          ${groups[g].map(q => `
            <div class="question">
              <div class="q-text">${q.text}</div>
              <div class="q-score">Score: ${q.score ?? "N/A"}</div>
            </div>
          `).join("")}
        </div>
      `;
    }).join("");
}

run();
</script>
</body>
</html>
