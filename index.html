<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{ --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D; --pill:#e9f6f0;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    body{font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:start}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}
    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    table{width:100%;border-collapse:collapse;margin-top:12px;border:1px solid var(--border-color);border-radius:6px;overflow:hidden}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border-color);vertical-align:top}
    th{background-color:var(--primary-color);color:white;font-weight:600}
    tr:hover{background-color:rgba(99,171,143,.05)}
    .table-container{overflow-x:auto;border:1px solid var(--border-color);border-radius:6px;padding:1px;margin-top:10px}

    .checkbox-dropdown{position:relative;min-width:220px;width:100%}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer;width:100%;box-sizing:border-box}
    .cd-trigger .label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50;flex-shrink:0;margin-left:8px}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none;box-sizing:border-box}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px;width:100%;box-sizing:border-box}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer;white-space:nowrap}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:#6c757d;display:flex;justify-content:space-between}

    .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    .comment-bubble{background:#f8f9fa;border:1px solid #dee2e6;border-radius:12px;padding:8px 12px;margin-top:4px;font-size:12px;color:#6c757d}
    
    .rating-indicator{display:inline-block;width:20px;height:20px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .rating-5{background-color:#22c55e}
    .rating-4{background-color:#86efac}
    .rating-3{background-color:#f59e0b}
    .rating-2{background-color:#fdba74}
    .rating-1{background-color:#ef4444}
    
    .badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;border:1px solid var(--border-color);background:#fff}
    .badge-excellent{color:#14532d;background:#dcfce7;border-color:#bbf7d0}
    .badge-good{color:#166534;background:#bbf7d0;border-color:#86efac}
    .badge-fair{color:#f59e0b;background:#fef3c7;border-color:#fde68a}
    .badge-poor{color:#d97706;background:#fed7aa;border-color:#fdba74}
    .badge-very-poor{color:#b4231a;background:#fee2e2;border-color:#fecaca}
    
    .expandable-row { cursor: pointer; }
    .expandable-content { display: none; padding: 20px; background: var(--light-bg); border-top: 1px solid var(--border-color); }
    .expand-icon { margin-right: 8px; transition: transform 0.3s; }
    .expanded .expand-icon { transform: rotate(90deg); }
    
    .survey-details { margin-top: 10px; padding-left: 20px; border-left: 3px solid var(--primary-color); }
    .survey-question { margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid var(--border-color); }
    
    .stat-card { background: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .stat-card .value { font-size: 32px; font-weight: bold; color: var(--primary-color); }
    .stat-card .label { font-size: 14px; color: var(--text-light); margin-top: 8px; }
    
    .no-data { text-align: center; padding: 40px; color: var(--text-light); }
    
    .question-text {
      font-style: italic;
      color: #6c757d;
      margin: 5px 0;
      font-size: 13px;
    }
    
    .question-group {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 12px;
      margin: 15px 0;
    }
    
    .question-group-title {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .score-display {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .conversation-time {
      color: var(--text-light);
      font-size: 12px;
      margin-top: 4px;
    }
    
    .score-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 13px;
      margin-right: 8px;
    }
    
    .score-5 { background: #dcfce7; color: #14532d; }
    .score-4 { background: #bbf7d0; color: #166534; }
    .score-3 { background: #fef3c7; color: #854d0e; }
    .score-2 { background: #fed7aa; color: #9a3412; }
    .score-1 { background: #fee2e2; color: #7f1d1d; }
    
    .score-9, .score-10 { background: #dcfce7; color: #14532d; }
    .score-7, .score-8 { background: #bbf7d0; color: #166534; }
    .score-5, .score-6 { background: #fef3c7; color: #854d0e; }
    .score-3, .score-4 { background: #fed7aa; color: #9a3412; }
    .score-1, .score-2 { background: #fee2e2; color: #7f1d1d; }
    
    .warning-note {
      background: #fff7ed;
      border: 1px solid #fed7aa;
      border-radius: 6px;
      padding: 12px;
      margin: 15px 0;
      color: #9a3412;
      font-size: 13px;
    }
    
    .duration-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      background: #f3f4f6;
      color: #4b5563;
      margin-left: 6px;
    }
    
    .feedback-text {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
      margin-top: 8px;
      font-size: 13px;
      color: #495057;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="authCard" class="card" style="display:block;">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">CSAT Survey Viewer</h2>
      <div class="controls">
        <div>
          <label for="userDropdown">Agents</label>
          <div id="userDropdown" class="checkbox-dropdown"></div>
        </div>
        <div>
          <label for="teamDropdown">Work Teams</label>
          <div id="teamDropdown" class="checkbox-dropdown"></div>
        </div>
        <div>
          <label for="fromDate">From Date</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label for="toDate">To Date</label>
          <input id="toDate" type="date">
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadBtn" class="full-width-btn">
            <span class="loading-spinner" style="display:none"></span>
            <span class="btn-text">Load Surveys</span>
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="section-title">Survey Responses</h2>
      <div id="surveysContainer" class="no-data">Select date range and click "Load Surveys" to begin</div>
    </div>
  </div>

  <script>
    // ===== OAuth Configuration =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const config = { REGION: 'mypurecloud.ie' };
    const redirectUri = 'https://gmcglynn88.github.io/CSAT-Insights/';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&state=csat`;

    const state = {
      accessToken: null,
      users: [],
      teams: [],
      teamMembers: new Map(),
      surveys: []
    };

    const dropdowns = { 
      users: null, 
      teams: null 
    };

    // ===== Helper Functions =====
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function msg(html,type='info'){
      const box=document.getElementById('messageContainer');
      box.innerHTML=`<div class="${type}-message">${html}</div>`;
      box.style.display='block';
      if(type==='success'){ setTimeout(()=>box.style.display='none',5000); }
    }

    function setLoading(button,isLoading){
      const spinner=button.querySelector('.loading-spinner');
      const text=button.querySelector('.btn-text');
      if(isLoading){ 
        spinner.style.display='inline-block'; 
        text.textContent='Loading...'; 
        button.disabled=true; 
      } else { 
        spinner.style.display='none'; 
        text.textContent='Load Surveys'; 
        button.disabled=false; 
      }
    }

    function safeGet(o,p,def=null){ 
      try{ 
        return p.split('.').reduce((x,k)=>(x && k in x)?x[k]:undefined ,o) ?? def; 
      } catch{ 
        return def; 
      } 
    }

    function formatDateOnly(d) {
      const dt = new Date(d);
      return dt.toLocaleDateString('en-GB', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric' 
      });
    }
    
    function formatTimeOnly(d) {
      const dt = new Date(d);
      return dt.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
    
    function formatDateTime(d) {
      const dt = new Date(d);
      return dt.toLocaleString('en-GB', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function formatDuration(seconds) {
      if (!seconds || seconds <= 0) return '0s';
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
      } else {
        return `${secs}s`;
      }
    }

    function getRatingLabel(score){
      if(score >= 90) return {label: 'Excellent', class: 'excellent', badge: 'badge-excellent'};
      if(score >= 70) return {label: 'Good', class: 'good', badge: 'badge-good'};
      if(score >= 50) return {label: 'Fair', class: 'fair', badge: 'badge-fair'};
      if(score >= 30) return {label: 'Poor', class: 'poor', badge: 'badge-poor'};
      return {label: 'Very Poor', class: 'very-poor', badge: 'badge-very-poor'};
    }

    // ===== OAuth Flow =====
    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM loaded, starting OAuth flow...');

      const rawHash = (window.location.hash || '').replace(/^#/, '');
      const params = new URLSearchParams(rawHash);

      // OAuth error
      const oauthError = params.get('error');
      if (oauthError) {
        const desc = decodeURIComponent(params.get('error_description') || '');
        console.error('OAuth error:', oauthError, desc);
        history.replaceState(null, document.title, window.location.pathname + window.location.search);
        sessionStorage.removeItem('purecloud_csat_token');
        sessionStorage.removeItem('purecloud_csat_token_exp');

        document.getElementById('auth-message').textContent = 'Sign-in failed. Please refresh the page to try again.';
        document.getElementById('auth-message').className = 'error-message';
        return;
      }

      // Token in hash
      const tokenFromHash = params.get('access_token');
      if (tokenFromHash) {
        console.log('Token found in hash');
        const expiresIn = parseInt(params.get('expires_in') || '0', 10);
        const expAt = expiresIn ? Date.now() + (expiresIn - 60) * 1000 : 0;
        sessionStorage.setItem('purecloud_csat_token', tokenFromHash);
        if (expAt) sessionStorage.setItem('purecloud_csat_token_exp', String(expAt));
        history.replaceState(null, document.title, window.location.pathname + window.location.search);
        startApp(tokenFromHash);
        return;
      }

      // Token from session
      const tokenFromSession = sessionStorage.getItem('purecloud_csat_token');
      const exp = parseInt(sessionStorage.getItem('purecloud_csat_token_exp') || '0', 10);
      if (tokenFromSession && (!exp || Date.now() < exp)) {
        console.log('Token found in session storage');
        startApp(tokenFromSession);
        return;
      }

      // No token yet - redirect to OAuth
      console.log('No token found, redirecting to OAuth');
      document.getElementById('auth-message').textContent = 'Redirecting to Genesys Cloud for authentication...';
      setTimeout(function(){ window.location.href = oauthUrl; }, 200);
    });

    // ===== App Initialization =====
    function startApp(token){
      console.log('Starting app with token');
      state.accessToken = token;
      
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('auth-message').className = 'success-message';
      
      setTimeout(() => { 
        document.getElementById('authCard').style.display = 'none'; 
        document.getElementById('appContent').style.display = 'block';
      }, 800);

      // Initialize dropdowns
      dropdowns.users = createCheckboxDropdown('userDropdown', {
        placeholder: 'Select agents (optional)', 
        searchPlaceholder: 'Search agents...'
      });
      
      dropdowns.teams = createCheckboxDropdown('teamDropdown', {
        placeholder: 'Select work teams (optional)', 
        searchPlaceholder: 'Search teams...'
      });

      // Set button handler
      document.getElementById('loadBtn').onclick = loadSurveys;

      // Set default dates (last 7 days)
      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 7);
      
      document.getElementById('fromDate').value = sevenDaysAgo.toISOString().split('T')[0];
      document.getElementById('toDate').value = today.toISOString().split('T')[0];
      
      // Set max date to today for both inputs
      const todayStr = today.toISOString().split('T')[0];
      document.getElementById('fromDate').max = todayStr;
      document.getElementById('toDate').max = todayStr;
      
      // Set min date to 90 days ago (allows 90-day search)
      const ninetyDaysAgo = new Date();
      ninetyDaysAgo.setDate(today.getDate() - 90);
      document.getElementById('fromDate').min = ninetyDaysAgo.toISOString().split('T')[0];
      document.getElementById('toDate').min = ninetyDaysAgo.toISOString().split('T')[0];

      // Load users and teams
      Promise.all([fetchAllUsers(), fetchAllTeams()])
        .then(() => {
          console.log('Initial data loaded');
        })
        .catch(err => {
          console.error('Initial load failed:', err);
          msg('Initial load failed: ' + err.message, 'error');
        });
    }

    // ===== Checkbox Dropdown Component =====
    function createCheckboxDropdown(containerId, {placeholder, searchPlaceholder}){
      const root = document.getElementById(containerId); 
      root.innerHTML = '';
      
      const trigger = document.createElement('div'); 
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);
      
      const panel = document.createElement('div'); 
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions"><button type="button" data-cd="clear">Clear</button></div>
        </div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>`;
      
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = []; 
      let selected = new Set();

      function render(filter=''){
        const ft = filter.trim().toLowerCase(); 
        list.innerHTML = '';
        
        const filtered = !ft ? options : options.filter(o => (o.label || '').toLowerCase().includes(ft));
        
        if(!filtered.length){ 
          list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`; 
          return; 
        }
        
        filtered.forEach(o => {
          const id = `${containerId}__${o.value}`;
          const row = document.createElement('div'); 
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value) ? 'checked' : ''}/>
              <span>${o.label || o.value}</span>
            </label>`;
          
          row.querySelector('input').addEventListener('change', (e) => {
            if(e.target.checked) selected.add(o.value);
            else selected.delete(o.value);
            updateSummary();
            updateSelectAllState();
          });
          
          list.appendChild(row);
        });
      }
      
      function updateSummary(){ 
        trigger.querySelector('.count').textContent = `${selected.size} selected`; 
        summary.textContent = `${selected.size} selected`; 
      }
      
      function updateSelectAllState(){ 
        const total = options.length, count = selected.size; 
        selectAll.indeterminate = count > 0 && count < total; 
        selectAll.checked = total > 0 && count === total; 
      }

      // Event listeners
      trigger.addEventListener('click', () => { 
        panel.classList.toggle('open'); 
        search.focus(); 
      });
      
      document.addEventListener('click', (e) => { 
        if(!root.contains(e.target)) panel.classList.remove('open'); 
      });
      
      search.addEventListener('input', () => render(search.value));
      
      clearBtn.addEventListener('click', () => { 
        selected.clear(); 
        render(search.value); 
        updateSummary(); 
        updateSelectAllState(); 
      });
      
      selectAll.addEventListener('change', () => { 
        if(selectAll.checked) options.forEach(o => selected.add(o.value));
        else selected.clear();
        render(search.value); 
        updateSummary(); 
      });

      function setOptions(newOptions){ 
        options = newOptions || []; 
        selected.forEach(v => { 
          if(!options.some(o => o.value === v)) selected.delete(v); 
        }); 
        render(search.value); 
        updateSummary(); 
        updateSelectAllState(); 
      }
      
      function getSelectedValues(){ 
        return Array.from(selected); 
      }

      render('');
      
      return { setOptions, getSelectedValues };
    }

    // ===== API Functions =====
    async function fetchJsonWithRetry(url, options = {}, {retries = 3, baseDelay = 500} = {}){
      let attempt = 0;
      
      while(true){
        try {
          console.log(`API call attempt ${attempt + 1}: ${url}`);
          if (options.body) {
            console.log('Request body:', options.body);
          }
          
          const response = await fetch(url, {
            ...options,
            headers: {
              'Authorization': 'Bearer ' + state.accessToken,
              'Content-Type': 'application/json',
              ...(options.headers || {})
            }
          });
          
          console.log(`Response status: ${response.status} ${response.statusText}`);
          
          if(response.ok){
            if(response.status === 204) return null;
            const data = await response.json();
            console.log('Response data:', data);
            return data;
          }
          
          // Log complete error details
          const errorText = await response.text();
          console.error('API Error Details:', {
            status: response.status,
            statusText: response.statusText,
            url: url,
            body: errorText
          });
          
          if([400,401,403,404].includes(response.status)){
            if(response.status === 401 || response.status === 403) {
              // Token expired
              sessionStorage.removeItem('purecloud_csat_token');
              sessionStorage.removeItem('purecloud_csat_token_exp');
              document.getElementById('appContent').style.display = 'none';
              document.getElementById('authCard').style.display = 'block';
              document.getElementById('auth-message').textContent = 'Session expired. Redirecting to login...';
              document.getElementById('auth-message').className = 'info-message';
              setTimeout(() => { window.location.href = oauthUrl; }, 2000);
              throw new Error('Authentication required');
            }
            throw new Error(`HTTP ${response.status}`);
          }
          
          attempt++;
          if(attempt > retries){
            throw new Error(`HTTP ${response.status} after ${retries} retries`);
          }
          
          const delay = Math.round(baseDelay * (2 ** (attempt - 1)) * (1 + Math.random() * 0.25));
          await sleep(delay);
        } catch (error) {
          console.error('Fetch error:', error);
          throw error;
        }
      }
    }

    async function fetchPaginatedGET(url){
      let all = []; 
      let next = url;
      
      while(next){
        const data = await fetchJsonWithRetry(next, {method: 'GET'});
        
        if(Array.isArray(data.entities)) all = all.concat(data.entities);
        else if(Array.isArray(data.users)) all = all.concat(data.users);
        else if(Array.isArray(data)) all = all.concat(data);
        else if(data.entities) all = all.concat(data.entities);
        
        next = data.nextUri ? `https://api.${config.REGION}${data.nextUri}` : null;
      }
      
      return all;
    }

    async function fetchAllUsers(){
      try {
        console.log('Fetching users...');
        const url = `https://api.${config.REGION}/api/v2/users?pageSize=100`;
        const users = await fetchPaginatedGET(url);
        
        state.users = users.map(u => ({
          id: u.id,
          name: (u.name || `${u.givenName || ''} ${u.familyName || ''}`).trim(),
          email: u.email || ''
        })).sort((a, b) => a.name.localeCompare(b.name));
        
        dropdowns.users.setOptions(state.users.map(u => ({
          value: u.id,
          label: `${u.name}${u.email ? ` — ${u.email}` : ''}`
        })));
        
        console.log(`Loaded ${state.users.length} users`);
      } catch (err) {
        console.error('Failed to fetch users:', err);
        throw new Error('Failed to load users: ' + err.message);
      }
    }

    async function fetchAllTeams(){
      try {
        console.log('Fetching teams...');
        const url = `https://api.${config.REGION}/api/v2/teams?pageSize=100`;
        const teams = await fetchPaginatedGET(url);
        
        state.teams = teams.map(t => ({
          id: t.id,
          name: t.name || '(Unnamed team)'
        })).sort((a, b) => a.name.localeCompare(b.name));
        
        dropdowns.teams.setOptions(state.teams.map(t => ({
          value: t.id,
          label: t.name
        })));
        
        console.log(`Loaded ${state.teams.length} teams`);
      } catch (err) {
        console.error('Failed to fetch teams:', err);
        throw new Error('Failed to load teams: ' + err.message);
      }
    }

    async function ensureTeamMembersLoaded(teamIds){
      const missing = teamIds.filter(id => !state.teamMembers.has(id));
      if(!missing.length) return;
      
      await Promise.all(missing.map(fetchTeamMembers));
    }

    async function fetchTeamMembers(teamId){
      const url = `https://api.${config.REGION}/api/v2/teams/${teamId}/members?pageSize=100`;
      const members = await fetchPaginatedGET(url);
      
      const ids = Array.from(new Set(members.map(m => 
        safeGet(m, 'member.id') || 
        safeGet(m, 'member.user.id') || 
        safeGet(m, 'user.id') || 
        safeGet(m, 'id')
      ).filter(Boolean)));
      
      state.teamMembers.set(teamId, ids);
    }

    async function computeSelectedAgentIds(){
      const userIds = dropdowns.users.getSelectedValues();
      const teamIds = dropdowns.teams.getSelectedValues();
      const set = new Set(userIds);
      
      if(teamIds.length){
        await ensureTeamMembersLoaded(teamIds);
        teamIds.forEach(tid => {
          (state.teamMembers.get(tid) || []).forEach(uid => set.add(uid));
        });
      }
      
      return Array.from(set);
    }

    // ===== Main Survey Loading =====
    async function loadSurveys(){
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      
      if(!fromDate || !toDate){
        msg('Please select both From and To dates.', 'error');
        return;
      }
      
      // Validate date range (max 90 days)
      const start = new Date(fromDate + 'T00:00:00.000Z');
      const end = new Date(toDate + 'T23:59:59.999Z');
      const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
      
      if (diffDays > 90) {
        msg('Date range cannot exceed 90 days. Please select a smaller range.', 'error');
        return;
      }
      
      if (diffDays < 0) {
        msg('End date must be after start date.', 'error');
        return;
      }
      
      const agentIds = await computeSelectedAgentIds();
      
      const btn = document.getElementById('loadBtn'); 
      setLoading(btn, true); 
      msg('Loading survey data...', 'info');
      
      try {
        // Use the conversations details API to get accurate survey data
        const conversationData = await fetchConversationDetails(start, end, agentIds);
        
        // Process and organize the data
        state.surveys = processConversationData(conversationData);
        
        renderSurveys();
        msg(`Loaded ${state.surveys.length} survey responses.`, 'success');
      } catch(e) { 
        console.error('Error loading surveys:', e); 
        msg('Failed to load surveys: ' + e.message, 'error'); 
      } finally { 
        setLoading(btn, false); 
      }
    }

    // Fetch conversation details using conversations details API
    async function fetchConversationDetails(start, end, agentIds) {
      const url = `https://api.${config.REGION}/api/v2/analytics/conversations/details/query`;
      
      // Format dates correctly for the API
      const startISO = start.toISOString();
      const endISO = end.toISOString();
      
      // Build the request body
      const body = {
        "interval": `${startISO}/${endISO}`,
        "order": "desc",
        "orderBy": "conversationStart",
        "paging": {
          "pageSize": 100,
          "pageNumber": 1
        },
        "segmentFilters": [
          {
            "type": "and",
            "predicates": [
              {
                "type": "dimension",
                "dimension": "mediaType",
                "operator": "matches",
                "value": "voice"
              },
              {
                "type": "dimension",
                "dimension": "evaluations",
                "operator": "exists"
              }
            ]
          }
        ]
      };
      
      // Add agent filter if agents are selected
      if (agentIds && agentIds.length > 0) {
        body.segmentFilters[0].predicates.push({
          "type": "or",
          "predicates": agentIds.map(agentId => ({
            "type": "dimension",
            "dimension": "participantId",
            "operator": "matches",
            "value": agentId
          }))
        });
      }
      
      console.log('Fetching conversation details with body:', JSON.stringify(body, null, 2));
      
      try {
        const data = await fetchJsonWithRetry(url, {
          method: 'POST',
          body: JSON.stringify(body)
        });
        
        console.log('Conversation details response:', data);
        return data;
      } catch (error) {
        console.error('Error fetching conversation details:', error);
        throw error;
      }
    }

    // Process conversation data to extract survey information
    function processConversationData(conversationData) {
      if (!conversationData || !conversationData.conversations) {
        console.log('No conversation data found or invalid response structure');
        return [];
      }
      
      const surveys = [];
      
      console.log(`Processing ${conversationData.conversations.length} conversations`);
      
      conversationData.conversations.forEach((conversation, index) => {
        const convId = conversation.conversationId;
        const participants = conversation.participants || [];
        
        // Find the agent (assuming they have purpose "agent")
        const agentParticipant = participants.find(p => p.purpose === "agent");
        const userId = agentParticipant?.participantId;
        
        if (!convId || !userId) {
          console.log(`Skipping conversation ${index}: missing conversationId or agent userId`);
          return;
        }
        
        // Get conversation start time
        const conversationStart = conversation.conversationStart;
        let conversationDate = conversationStart ? new Date(conversationStart) : new Date();
        
        // Get conversation duration
        const conversationEnd = conversation.conversationEnd;
        let duration = 0;
        if (conversationStart && conversationEnd) {
          const start = new Date(conversationStart);
          const end = new Date(conversationEnd);
          duration = Math.round((end - start) / 1000); // Convert to seconds
        }
        
        // Find agent name
        const agent = state.users.find(u => u.id === userId);
        const agentName = agent ? agent.name : 'Unknown Agent';
        
        // Extract survey evaluations
        const evaluations = conversation.evaluations || [];
        const surveysFromConversation = evaluations.filter(eval => eval.formName);
        
        if (surveysFromConversation.length === 0) {
          // No survey evaluations in this conversation
          return;
        }
        
        // Process each survey in the conversation
        surveysFromConversation.forEach(surveyEval => {
          const formName = surveyEval.formName;
          const totalScore = surveyEval.totalScore || 0;
          const totalCriticalScore = surveyEval.totalCriticalScore || 0;
          
          // Extract question scores
          const questionScores = [];
          if (surveyEval.questionGroupScores && Array.isArray(surveyEval.questionGroupScores)) {
            surveyEval.questionGroupScores.forEach(group => {
              if (group.questionScores && Array.isArray(group.questionScores)) {
                group.questionScores.forEach(qScore => {
                  questionScores.push({
                    score: qScore.score || 0,
                    maxScore: qScore.maxScore || 0,
                    questionId: qScore.questionId,
                    answerText: qScore.answerText,
                    markedNA: qScore.markedNA || false
                  });
                });
              }
            });
          }
          
          // Extract free text feedback
          let freeTextFeedback = '';
          if (surveyEval.answers && surveyEval.answers.formAnswers) {
            Object.values(surveyEval.answers.formAnswers).forEach(answer => {
              if (answer.textResponse && answer.textResponse.trim()) {
                freeTextFeedback = answer.textResponse.trim();
              }
            });
          }
          
          surveys.push({
            conversationId: convId,
            userId: userId,
            agentName: agentName,
            surveyFormName: formName || 'Unknown Survey',
            conversationDate: conversationDate,
            conversationStart: conversationStart,
            conversationEnd: conversationEnd,
            duration: duration,
            totalScore: totalScore,
            totalCriticalScore: totalCriticalScore,
            questionScores: questionScores,
            freeTextFeedback: freeTextFeedback,
            isEstimatedTime: false // Now we have actual conversation times
          });
        });
      });
      
      console.log(`Processed ${surveys.length} surveys from conversations`);
      return surveys;
    }

    // Map survey questions to our standard question groups
    function mapQuestionsToGroups(questionScores, freeTextFeedback) {
      const groups = [
        {
          name: 'Enquiry Management',
          questions: []
        },
        {
          name: 'Advisor Experience',
          questions: []
        },
        {
          name: 'Overall Experience',
          questions: []
        },
        {
          name: 'Any Feedback',
          questions: []
        }
      ];
      
      // Try to map the actual questions to our groups based on common patterns
      questionScores.forEach(qScore => {
        const questionText = qScore.answerText || '';
        const score = qScore.score || 0;
        const maxScore = qScore.maxScore || 0;
        
        // Determine which group this question belongs to based on common keywords
        let targetGroup = groups[3]; // Default to feedback
        
        if (maxScore > 0) { // Scored question
          if (questionText.toLowerCase().includes('easy') || questionText.toLowerCase().includes('handling')) {
            targetGroup = groups[0]; // Enquiry Management
          } else if (questionText.toLowerCase().includes('satisfied') || questionText.toLowerCase().includes('advisor') || questionText.toLowerCase().includes('handled')) {
            targetGroup = groups[1]; // Advisor Experience
          } else if (questionText.toLowerCase().includes('recommend') || questionText.toLowerCase().includes('likely')) {
            targetGroup = groups[2]; // Overall Experience
          }
          
          targetGroup.questions.push({
            text: questionText || 'Survey question',
            score: score,
            maxScore: maxScore,
            percentage: maxScore > 0 ? (score / maxScore) * 100 : 0
          });
        }
      });
      
      // Add free text feedback if available
      if (freeTextFeedback) {
        groups[3].questions.push({
          text: freeTextFeedback,
          score: 0,
          maxScore: 0,
          percentage: 0,
          isFreeText: true
        });
      }
      
      return groups;
    }

    // ===== Render Surveys =====
    function renderSurveys(){
      const container = document.getElementById('surveysContainer');
      
      if(!state.surveys || state.surveys.length === 0){
        container.innerHTML = `
          <div class="stat-card">
            <div class="value">0</div>
            <div class="label">Survey Responses Found</div>
          </div>
          <div class="muted">No survey responses found for the selected criteria.</div>
        `;
        return;
      }
      
      // Calculate statistics
      const totalSurveys = state.surveys.length;
      const totalScore = state.surveys.reduce((sum, s) => sum + (s.totalScore || 0), 0);
      const avgScore = totalSurveys > 0 ? totalScore / totalSurveys : 0;
      
      let html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
          <div class="stat-card">
            <div class="value">${totalSurveys}</div>
            <div class="label">Survey Responses</div>
          </div>
          <div class="stat-card">
            <div class="value">${avgScore.toFixed(1)}%</div>
            <div class="label">Average Score</div>
          </div>
        </div>
        
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Agent</th>
                <th>Date & Time</th>
                <th>Duration</th>
                <th>Survey Form</th>
                <th>Score</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      let rowIndex = 0;
      
      // Sort surveys by date (newest first)
      const sortedSurveys = [...state.surveys].sort((a, b) => b.conversationDate - a.conversationDate);
      
      sortedSurveys.forEach((survey) => {
        const score = survey.totalScore || 0;
        const rating = getRatingLabel(score);
        const roundedScore = Math.min(5, Math.max(1, Math.round(score / 20))); // Convert 0-100 to 1-5 scale for rating indicator
        const dateTime = formatDateTime(survey.conversationDate);
        const duration = formatDuration(survey.duration);
        
        // Map questions to groups
        const questionGroups = mapQuestionsToGroups(survey.questionScores || [], survey.freeTextFeedback || '');
        
        html += `
          <tr class="expandable-row" onclick="toggleSurveyRow(${rowIndex})">
            <td><strong>${survey.agentName}</strong></td>
            <td>${dateTime}</td>
            <td>${duration ? `<span class="duration-badge">${duration}</span>` : 'N/A'}</td>
            <td>${survey.surveyFormName || 'Unknown'}</td>
            <td>
              <span class="rating-indicator rating-${roundedScore}"></span>
              <span class="badge ${rating.badge}">${score.toFixed(1)}% - ${rating.label}</span>
            </td>
            <td><span class="expand-icon">▶</span> Click to expand</td>
          </tr>
          <tr id="survey-row-${rowIndex}" class="expandable-content">
            <td colspan="6">
              <div class="survey-details">
                <div><strong>Agent:</strong> ${survey.agentName}</div>
                <div><strong>Date & Time:</strong> ${dateTime}</div>
                <div><strong>Duration:</strong> ${duration || 'N/A'}</div>
                <div><strong>Survey Form:</strong> ${survey.surveyFormName || 'Unknown'}</div>
                <div><strong>Total Score:</strong> ${score.toFixed(1)}%</div>
                
                <h5 style="margin-top: 15px;">Question Responses:</h5>
                
                ${questionGroups.map((group, groupIndex) => {
                  if (group.questions.length === 0) return '';
                  
                  return `
                    <div class="question-group">
                      <div class="question-group-title">${group.name}</div>
                      ${group.questions.map((q, qIndex) => {
                        if (q.isFreeText) {
                          return `
                            <div class="survey-question">
                              <div class="question-text">Customer Feedback:</div>
                              <div class="feedback-text">"${q.text}"</div>
                            </div>
                          `;
                        } else {
                          // Determine CSS class based on score
                          const percentage = q.percentage;
                          let scoreClass = '';
                          
                          if (q.maxScore === 10) {
                            const roundedScore = Math.min(10, Math.max(1, q.score));
                            scoreClass = `score-${roundedScore}`;
                          } else if (q.maxScore === 5) {
                            const roundedScore = Math.min(5, Math.max(1, q.score));
                            scoreClass = `score-${roundedScore}`;
                          }
                          
                          return `
                            <div class="survey-question">
                              <div class="question-text">${q.text}</div>
                              <div>
                                <strong>Score:</strong> 
                                <span class="score-badge ${scoreClass}">
                                  ${q.score}/${q.maxScore}
                                </span>
                                <span class="score-display">
                                  (${percentage.toFixed(0)}%)
                                </span>
                              </div>
                            </div>
                          `;
                        }
                      }).join('')}
                    </div>
                  `;
                }).join('')}
              </div>
            </td>
          </tr>
        `;
        
        rowIndex++;
      });
      
      html += `
            </tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px">
          Showing ${sortedSurveys.length} survey responses with actual conversation times and scores
        </div>
      `;
      
      container.innerHTML = html;
    }

    // ===== Global Functions for HTML =====
    window.toggleSurveyRow = function(index) {
      const row = document.getElementById(`survey-row-${index}`);
      const icon = document.querySelector(`#survey-row-${index}`).previousElementSibling.querySelector('.expand-icon');
      
      if (row.style.display === 'none' || !row.style.display) {
        row.style.display = 'table-row';
        icon.textContent = '▼';
        icon.classList.add('expanded');
      } else {
        row.style.display = 'none';
        icon.textContent = '▶';
        icon.classList.remove('expanded');
      }
    };
  </script>
</body>
</html>
