<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{ --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D; --pill:#e9f6f0;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    body{font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)}
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:start}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}
    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    table{width:100%;border-collapse:collapse;margin-top:12px;border:1px solid var(--border-color);border-radius:6px;overflow:hidden}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border-color);vertical-align:top}
    th{background-color:var(--primary-color);color:white;font-weight:600}
    tr:hover{background-color:rgba(99,171,143,.05)}
    .table-container{overflow-x:auto;border:1px solid var(--border-color);border-radius:6px;padding:1px;margin-top:10px}

    /* Frozen column styling */
    .frozen-table-container { position: relative; overflow: auto; border: 1px solid var(--border-color); border-radius: 6px; margin-top: 10px; max-height: 600px; -webkit-overflow-scrolling: touch; }
    .frozen-table { border-collapse: separate; border-spacing: 0; width: max-content; min-width: 100%; }
    .frozen-table th, .frozen-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: top; white-space: nowrap; background: var(--card-bg); position: relative; }
    .frozen-table thead th { background-color: var(--primary-color); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    .frozen-table th:first-child, .frozen-table td:first-child { position: sticky; left: 0; background: var(--card-bg); background-clip: padding-box; z-index: 12; border-right: 2px solid var(--border-color); min-width: 220px; }
    .frozen-table thead th:first-child { z-index: 20; background: var(--primary-color); }
    .frozen-table tr:hover td { background-color: rgba(99,171,143,.05); }
    .frozen-table tr:hover td:first-child { background: rgba(99,171,143,.1); }

    .tab{display:inline-block;padding:12px 20px;margin-right:10px;background:#eee;cursor:pointer;border-radius:6px;font-weight:500}
    .tab.active{background:var(--primary-color);color:white}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;border:1px solid var(--border-color);background:#fff}
    .badge-excellent{color:#14532d;background:#dcfce7;border-color:#bbf7d0}
    .badge-good{color:#166534;background:#bbf7d0;border-color:#86efac}
    .badge-fair{color:#f59e0b;background:#fef3c7;border-color:#fde68a}
    .badge-poor{color:#d97706;background:#fed7aa;border-color:#fdba74}
    .badge-very-poor{color:#b4231a;background:#fee2e2;border-color:#fecaca}
    .badge-neutral{color:#6b7280;background:#f3f4f6;border-color:#e5e7eb}

    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .kpi{background:#fff;border:1px solid var(--border-color);border-radius:8px;padding:12px}
    .kpi .label{color:var(--text-light);font-size:12px}
    .kpi .value{font-size:20px;font-weight:700;margin-top:4px}

    .checkbox-dropdown{position:relative;min-width:220px;width:100%}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer;width:100%;box-sizing:border-box}
    .cd-trigger .label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50;flex-shrink:0;margin-left:8px}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none;box-sizing:border-box}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px;width:100%;box-sizing:border-box}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer;white-space:nowrap}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:#6c757d;display:flex;justify-content:space-between}

    .loading-spinner{display:inline-block;width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    .comment-bubble{background:#f8f9fa;border:1px solid #dee2e6;border-radius:12px;padding:8px 12px;margin-top:4px;font-size:12px;color:#6c757d}
    
    .rating-indicator{display:inline-block;width:20px;height:20px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .rating-5{background-color:#22c55e}
    .rating-4{background-color:#86efac}
    .rating-3{background-color:#f59e0b}
    .rating-2{background-color:#fdba74}
    .rating-1{background-color:#ef4444}
    .rating-na{background-color:#9ca3af}
    
    .rating-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}
    .rating-item{background:#fff;border:1px solid var(--border-color);border-radius:8px;padding:15px;text-align:center}
    .rating-item .count{font-size:28px;font-weight:800;line-height:1}
    .rating-item .label{color:var(--text-light);margin-top:8px;font-size:14px;font-weight:600}
    
    .survey-card{border-left:4px solid var(--border-color);margin-bottom:12px;padding:12px;background:#fff;border-radius:6px}
    .survey-card.rating-5{border-left-color:#22c55e}
    .survey-card.rating-4{border-left-color:#86efac}
    .survey-card.rating-3{border-left-color:#f59e0b}
    .survey-card.rating-2{border-left-color:#fdba74}
    .survey-card.rating-1{border-left-color:#ef4444}
    
    .contact-info{font-size:12px;color:var(--text-light);margin-top:4px}
    
    /* Filter controls */
    .details-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .details-filters .filter-group { display: flex; flex-direction: column; }
    .details-filters label { margin-bottom: 8px; }
    
    /* Expandable rows styling */
    .expandable-row { cursor: pointer; }
    .expandable-content { display: none; padding: 20px; background: var(--light-bg); border-top: 1px solid var(--border-color); }
    .expandable-content.expanded { display: table-row; }
    .expand-icon { margin-right: 8px; transition: transform 0.3s; }
    .expanded .expand-icon { transform: rotate(90deg); }
    
    /* Stats grid */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:20px}
    .stat-card{background:#fff;border:1px solid var(--border-color);border-radius:8px;padding:16px}
    .stat-card .value{font-size:32px;font-weight:800;color:var(--text-color)}
    .stat-card .label{font-size:14px;color:var(--text-light);margin-top:8px}
    .stat-card .trend{font-size:12px;margin-top:4px}
    .trend-up{color:#22c55e}
    .trend-down{color:#ef4444}
    .trend-neutral{color:#6b7280}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="authCard" class="card" style="display:block;">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">CSAT Survey Viewer</h2>
      <div class="controls">
        <div>
          <label for="userDropdown">Agents</label>
          <div id="userDropdown" class="checkbox-dropdown"></div>
        </div>
        <div>
          <label for="teamDropdown">Work Teams</label>
          <div id="teamDropdown" class="checkbox-dropdown"></div>
        </div>
        <div>
          <label for="fromDate">From Date</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label for="toDate">To Date</label>
          <input id="toDate" type="date">
        </div>
        <div>
          <label for="ratingFilter">Rating Filter</label>
          <select id="ratingFilter">
            <option value="all">All Ratings</option>
            <option value="5">5 - Excellent</option>
            <option value="4">4 - Good</option>
            <option value="3">3 - Fair</option>
            <option value="2">2 - Poor</option>
            <option value="1">1 - Very Poor</option>
            <option value="nps-promoter">NPS Promoters (9-10)</option>
            <option value="nps-passive">NPS Passive (7-8)</option>
            <option value="nps-detractor">NPS Detractors (0-6)</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadBtn" class="full-width-btn">
            <span class="loading-spinner" style="display:none"></span>
            <span class="btn-text">Load Surveys</span>
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="margin-bottom:10px;">
        <div id="tabs">
          <div id="overviewTabButton" class="tab active">Overview</div>
          <div id="surveysTabButton" class="tab">Survey Details</div>
          <div id="analyticsTabButton" class="tab">Analytics</div>
          <div id="trendsTabButton" class="tab">Trends</div>
        </div>
      </div>

      <div id="overviewTab" class="tab-content active">
        <h2 class="section-title">Survey Overview</h2>
        
        <div class="rating-summary" id="ratingSummary"></div>
        
        <div class="stats-grid" id="statsGrid"></div>
        
        <h3 class="section-title">Survey Responses</h3>
        <div class="table-container">
          <table id="surveysTable"></table>
        </div>
      </div>

      <div id="surveysTab" class="tab-content">
        <h2 class="section-title">Detailed Survey Responses</h2>
        
        <div class="details-filters">
          <div class="filter-group">
            <label for="detailsAgentFilter">Filter by Agent</label>
            <select id="detailsAgentFilter" class="full-width-btn">
              <option value="all">All Agents</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="detailsRatingFilter">Filter by Rating</label>
            <select id="detailsRatingFilter" class="full-width-btn">
              <option value="all">All Ratings</option>
              <option value="5">5 - Excellent</option>
              <option value="4">4 - Good</option>
              <option value="3">3 - Fair</option>
              <option value="2">2 - Poor</option>
              <option value="1">1 - Very Poor</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button id="applyFiltersBtn" class="full-width-btn">Apply Filters</button>
          </div>
        </div>
        
        <div id="surveysContainer"></div>
      </div>

      <div id="analyticsTab" class="tab-content">
        <h2 class="section-title">Survey Analytics</h2>
        
        <div class="controls" style="margin-top:8px">
          <div>
            <label for="anaFromDate">From Date</label>
            <input id="anaFromDate" type="date">
          </div>
          <div>
            <label for="anaToDate">To Date</label>
            <input id="anaToDate" type="date">
          </div>
          <div>
            <label for="analyticsTeamDropdown">Filter by Work Team</label>
            <div id="analyticsTeamDropdown" class="checkbox-dropdown"></div>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="loadAnalyticsBtn" class="full-width-btn">
              <span class="loading-spinner" style="display:none"></span>
              <span class="btn-text">Load Analytics</span>
            </button>
          </div>
        </div>
        
        <div id="analyticsCharts" style="margin-top:20px;"></div>
      </div>

      <div id="trendsTab" class="tab-content">
        <h2 class="section-title">Survey Trends</h2>
        
        <div class="controls" style="margin-top:8px">
          <div>
            <label for="trendFromDate">From Date</label>
            <input id="trendFromDate" type="date">
          </div>
          <div>
            <label for="trendToDate">To Date</label>
            <input id="trendToDate" type="date">
          </div>
          <div>
            <label for="trendPeriod">Trend Period</label>
            <select id="trendPeriod">
              <option value="day">Daily</option>
              <option value="week">Weekly</option>
              <option value="month">Monthly</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="loadTrendsBtn" class="full-width-btn">
              <span class="loading-spinner" style="display:none"></span>
              <span class="btn-text">Load Trends</span>
            </button>
          </div>
        </div>
        
        <div id="trendsCharts" style="margin-top:20px;"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Configuration =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const config = { REGION: 'mypurecloud.ie' };
    const redirectUri = 'https://gmcglynn88.github.io/QualityReporting/';
    const oauthUrl = 'https://login.mypurecloud.ie/oauth/authorize?client_id=fe305808-b368-4547-8af9-325d28d552bb&response_type=token&redirect_uri=https%3A%2F%2Fgmcglynn88.github.io%2FQualityReporting%2F&state=csat';

    const state = {
      accessToken: null,
      users: [],
      teams: [],
      teamsById: {},
      teamMembers: new Map(),
      surveys: [],
      conversations: [],
      dateRange: null,
      
      // Filter states
      detailsAgentFilter: 'all',
      detailsRatingFilter: 'all',
      filteredSurveys: []
    };

    const dropdowns = { 
      users: null, 
      teams: null,
      analyticsTeams: null 
    };

    // Chart colours
    const cssVar = k => getComputedStyle(document.documentElement).getPropertyValue(k).trim();
    let COLORS = { 
      OK: '#22c55e', 
      WARN: '#f59e0b', 
      BAD: '#ef4444', 
      TEXT: '#2C3E50', 
      BLUE: '#3b82f6', 
      PRIMARY: '#63AB8F', 
      SECONDARY: '#4A8C7D',
      RATING_5: '#22c55e',
      RATING_4: '#86efac',
      RATING_3: '#f59e0b',
      RATING_2: '#fdba74',
      RATING_1: '#ef4444'
    };

    function resolveColors() {
      COLORS.OK   = cssVar('--ok')          || COLORS.OK;
      COLORS.WARN = cssVar('--warn')        || COLORS.WARN;
      COLORS.BAD  = cssVar('--bad')         || COLORS.BAD;
      COLORS.TEXT = cssVar('--text-color')  || COLORS.TEXT;
      COLORS.PRIMARY = cssVar('--primary-color') || COLORS.PRIMARY;
      COLORS.SECONDARY = cssVar('--secondary-color') || COLORS.SECONDARY;
    }

    // API throttling
    let lastApiCall = 0;
    const API_DELAY = 120;

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function msg(html,type='info'){
      const box=document.getElementById('messageContainer');
      box.innerHTML=`<div class="${type}-message">${html}</div>`;
      box.style.display='block';
      if(type==='success'){ setTimeout(()=>box.style.display='none',5000); }
    }

    function setLoading(button,isLoading){
      const spinner=button.querySelector('.loading-spinner');
      const text=button.querySelector('.btn-text');
      if(isLoading){ 
        spinner.style.display='inline-block'; 
        text.textContent='Loading...'; 
        button.disabled=true; 
      } else { 
        spinner.style.display='none'; 
        text.textContent = button.id==='loadTrendsBtn'?'Load Trends':
                          (button.id==='loadAnalyticsBtn'?'Load Analytics':'Load Surveys'); 
        button.disabled=false; 
      }
    }

    // ===== Checkbox dropdown =====
    function createCheckboxDropdown(containerId,{placeholder,searchPlaceholder}){
      const root=document.getElementById(containerId); root.innerHTML='';
      const trigger=document.createElement('div'); trigger.className='cd-trigger';
      trigger.innerHTML=`<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);
      const panel=document.createElement('div'); panel.className='cd-panel';
      panel.innerHTML=`
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions"><button type="button" data-cd="clear">Clear</button></div>
        </div>
        <div class="cd-selectall"><label><input type="checkbox" data-cd="selectall"/> Select all</label></div>
        <div class="cd-list"></div>
        <div class="cd-footer"><span data-cd="summary">0 selected</span><span>Click outside to close</span></div>`;
      root.appendChild(panel);

      const list=panel.querySelector('.cd-list');
      const search=panel.querySelector('.cd-search');
      const clearBtn=panel.querySelector('[data-cd="clear"]');
      const selectAll=panel.querySelector('[data-cd="selectall"]');
      const summary=panel.querySelector('[data-cd="summary"]');

      let options=[]; let selected=new Set();

      function render(filter=''){
        const ft=filter.trim().toLowerCase(); list.innerHTML='';
        const filtered=!ft?options:options.filter(o=>(o.label||'').toLowerCase().includes(ft));
        if(!filtered.length){ list.innerHTML=`<div class="cd-item" style="color:#6C757D">No matches</div>`; return; }
        filtered.forEach(o=>{
          const id=`${containerId}__${o.value}`;
          const row=document.createElement('div'); row.className='cd-item';
          row.innerHTML=`<label for="${id}"><input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/><span>${o.label||o.value}</span></label>`;
          row.querySelector('input').addEventListener('change',(e)=>{
            if(e.target.checked) selected.add(o.value);
            else selected.delete(o.value);
            updateSummary();
            updateSelectAllState();
          });
          list.appendChild(row);
        });
      }
      function updateSummary(){ trigger.querySelector('.count').textContent=`${selected.size} selected`; summary.textContent=`${selected.size} selected`; }
      function updateSelectAllState(){ const total=options.length,count=selected.size; selectAll.indeterminate=count>0&&count<total; selectAll.checked=total>0&&count===total; }

      trigger.addEventListener('click',()=>{ panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click',(e)=>{ if(!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input',()=>render(search.value));
      clearBtn.addEventListener('click',()=>{ selected.clear(); render(search.value); updateSummary(); updateSelectAllState(); });
      selectAll.addEventListener('change',()=>{ if(selectAll.checked) options.forEach(o=>selected.add(o.value)); else selected.clear(); render(search.value); updateSummary(); });

      function setOptions(newOptions){ options=newOptions||[]; selected.forEach(v=>{ if(!options.some(o=>o.value===v)) selected.delete(v); }); render(search.value); updateSummary(); updateSelectAllState(); }
      function getSelectedValues(){ return Array.from(selected); }

      render(''); return { setOptions, getSelectedValues };
    }

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', function () {
      resolveColors();
      console.log('DOM loaded, starting OAuth flow...');

      const rawHash = (window.location.hash || '').replace(/^#/, '');
      const params = new URLSearchParams(rawHash);

      // 1) OAuth error
      const oauthError = params.get('error');
      if (oauthError) {
        const desc = decodeURIComponent(params.get('error_description') || '');
        console.error('OAuth error:', oauthError, desc);
        history.replaceState(null, document.title, window.location.pathname + window.location.search);
        sessionStorage.removeItem('purecloud_csat_token');
        sessionStorage.removeItem('purecloud_csat_token_exp');

        document.getElementById('auth-message').textContent = 'Sign-in failed. Please refresh the page to try again.';
        document.getElementById('auth-message').className = 'error-message';
        return;
      }

      // 2) Token in hash
      const tokenFromHash = params.get('access_token');
      if (tokenFromHash) {
        console.log('Token found in hash');
        const expiresIn = parseInt(params.get('expires_in') || '0', 10);
        const expAt = expiresIn ? Date.now() + (expiresIn - 60) * 1000 : 0;
        sessionStorage.setItem('purecloud_csat_token', tokenFromHash);
        if (expAt) sessionStorage.setItem('purecloud_csat_token_exp', String(expAt));
        history.replaceState(null, document.title, window.location.pathname + window.location.search);
        startApp(tokenFromHash);
        return;
      }

      // 3) Token from session
      const tokenFromSession = sessionStorage.getItem('purecloud_csat_token');
      const exp = parseInt(sessionStorage.getItem('purecloud_csat_token_exp') || '0', 10);
      if (tokenFromSession && (!exp || Date.now() < exp)) {
        console.log('Token found in session storage');
        startApp(tokenFromSession);
        return;
      }

      // 4) No token yet - redirect to OAuth
      console.log('No token found, redirecting to OAuth');
      document.getElementById('auth-message').textContent = 'Redirecting to Genesys Cloud for authentication...';
      setTimeout(function(){ window.location.href = oauthUrl; }, 200);
    });

    function startApp(token){
      console.log('Starting app with token');
      state.accessToken=token;
      document.getElementById('auth-message').textContent='Authenticated successfully!';
      document.getElementById('auth-message').className='success-message';
      setTimeout(()=>{ document.getElementById('authCard').style.display='none'; }, 800);
      document.getElementById('appContent').style.display='block';

      dropdowns.users=createCheckboxDropdown('userDropdown',{placeholder:'Select agents (optional)',searchPlaceholder:'Search agents...'});
      dropdowns.teams=createCheckboxDropdown('teamDropdown',{placeholder:'Select work teams (optional)',searchPlaceholder:'Search teams...'});
      dropdowns.analyticsTeams=createCheckboxDropdown('analyticsTeamDropdown',{placeholder:'Filter teams (optional)',searchPlaceholder:'Search teams...'});

      // Tab navigation
      document.getElementById('overviewTabButton').onclick=()=>setTab('overview');
      document.getElementById('surveysTabButton').onclick=()=>setTab('surveys');
      document.getElementById('analyticsTabButton').onclick=()=>setTab('analytics');
      document.getElementById('trendsTabButton').onclick=()=>setTab('trends');
      
      // Button handlers
      document.getElementById('loadBtn').onclick=loadSurveys;
      document.getElementById('loadAnalyticsBtn').onclick=loadAnalytics;
      document.getElementById('loadTrendsBtn').onclick=loadTrends;
      document.getElementById('applyFiltersBtn').onclick=applyDetailsFilters;

      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('toDate').value = today.toISOString().split('T')[0];
      document.getElementById('anaFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('anaToDate').value = today.toISOString().split('T')[0];
      document.getElementById('trendFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('trendToDate').value = today.toISOString().split('T')[0];

      // Load users and teams
      Promise.all([fetchAllUsers(), fetchAllTeams()])
        .then(()=> {
          dropdowns.analyticsTeams.setOptions(state.teams.map(t=>({value:t.id,label:t.name})));
        })
        .catch(err => {
          console.error('Initial load failed:', err);
          msg('Initial load failed: '+err.message,'error');
        });
    }

    function setTab(name){
      ['overview','surveys','analytics','trends'].forEach(n=>{
        document.getElementById(`${n}Tab`).classList.toggle('active', n===name);
        document.getElementById(`${n}TabButton`).classList.toggle('active', n===name);
      });
      if(name==='surveys') renderSurveyDetails();
      if(name==='analytics') renderAnalytics();
      if(name==='trends') renderTrends();
    }

    // ===== HTTP helpers =====
    async function rawFetch(url,options={}){
      const now=Date.now(); const delta=now-lastApiCall;
      if(delta<API_DELAY) await sleep(API_DELAY-delta);
      lastApiCall=Date.now();
      return fetch(url,{...options,headers:{'Authorization':'Bearer '+state.accessToken,'Content-Type':'application/json',...(options.headers||{})}});
    }

    async function fetchJsonWithRetry(url, options={}, {retries=5, baseDelay=500}={}){
      let attempt=0;
      while(true){
        const res = await rawFetch(url, options);
        if(res.ok){
          if(res.status===204) return null;
          return await res.json();
        }
        if([400,401,403,404,405].includes(res.status)){
          if(res.status === 401 || res.status === 403) {
            sessionStorage.removeItem('purecloud_csat_token');
            sessionStorage.removeItem('purecloud_csat_token_exp');
            document.getElementById('appContent').style.display='none';
            document.getElementById('authCard').style.display='block';
            document.getElementById('auth-message').textContent='Session expired. Redirecting to login...';
            document.getElementById('auth-message').className='info-message';
            setTimeout(() => { window.location.href = oauthUrl; }, 2000);
            throw new Error('Authentication required');
          }
          const err=new Error(`HTTP ${res.status}`); err.status=res.status; throw err;
        }
        attempt++;
        if(attempt>retries){
          const err=new Error(`HTTP ${res.status}`); err.status=res.status; throw err;
        }
        const retryAfter = Number(res.headers.get('Retry-After')) || null;
        const delay = retryAfter ? retryAfter*1000 : Math.round(baseDelay * (2**(attempt-1)) * (1 + Math.random()*0.25));
        await sleep(delay);
      }
    }

    async function fetchPaginatedGET(url){
      let all=[]; let next=url;
      while(next){
        const data = await fetchJsonWithRetry(next, {method:'GET'});
        if(Array.isArray(data.entities)) all=all.concat(data.entities);
        else if(Array.isArray(data.users)) all=all.concat(data.users);
        else if(Array.isArray(data)) all=all.concat(data);
        else if(data.entities) all=all.concat(data.entities);
        next = data.nextUri ? `https://api.${config.REGION}${data.nextUri}` : null;
      }
      return all;
    }

    function safeGet(o,p,def=null){ 
      try{ 
        return p.split('.').reduce((x,k)=>(x && k in x)?x[k]:undefined ,o) ?? def; 
      } catch{ 
        return def; 
      } 
    }

    function toUKDate(d){ 
      const dt=new Date(d); 
      return dt.toLocaleDateString('en-GB'); 
    }
    
    function toDateTime(d){ 
      const dt=new Date(d); 
      return dt.toLocaleString('en-GB'); 
    }

    // ===== Data loading =====
    async function fetchAllUsers(){
      try {
        console.log('Fetching users...');
        const url=`https://api.${config.REGION}/api/v2/users?pageSize=100`;
        const users=await fetchPaginatedGET(url);
        state.users=users.map(u=>({id:u.id,name:(u.name || `${u.givenName||''} ${u.familyName||''}`).trim(),email:u.email||''})).sort((a,b)=>a.name.localeCompare(b.name));
        dropdowns.users.setOptions(state.users.map(u=>({value:u.id,label:`${u.name}${u.email?` â€” ${u.email}`:''}`})));
        console.log(`Loaded ${state.users.length} users`);
      } catch (err) {
        console.error('Failed to fetch users:', err);
        throw new Error('Failed to load users: ' + err.message);
      }
    }

    async function fetchAllTeams(){
      try {
        console.log('Fetching teams...');
        const url=`https://api.${config.REGION}/api/v2/teams?pageSize=100`;
        const teams = await fetchPaginatedGET(url);
        state.teams = teams.map(t=>({id:t.id,name:t.name||'(Unnamed team)'})).sort((a,b)=>a.name.localeCompare(b.name));
        state.teamsById = Object.fromEntries(state.teams.map(t=>[t.id,t]));
        dropdowns.teams.setOptions(state.teams.map(t=>({value:t.id,label:t.name})));
        console.log(`Loaded ${state.teams.length} teams`);
      } catch (err) {
        console.error('Failed to fetch teams:', err);
        throw new Error('Failed to load teams: ' + err.message);
      }
    }

    async function ensureTeamMembersLoaded(teamIds){
      const missing = teamIds.filter(id=>!state.teamMembers.has(id));
      if(!missing.length) return;
      await Promise.all(missing.map(fetchTeamMembers));
    }

    async function fetchTeamMembers(teamId){
      const url=`https://api.${config.REGION}/api/v2/teams/${teamId}/members?pageSize=100`;
      const members=await fetchPaginatedGET(url);
      const ids = Array.from(new Set(members.map(m => safeGet(m,'member.id') || safeGet(m,'member.user.id') || safeGet(m,'user.id') || safeGet(m,'id')).filter(Boolean)));
      state.teamMembers.set(teamId, ids);
    }

    async function computeSelectedAgentIds(){
      const userIds = dropdowns.users.getSelectedValues();
      const teamIds = dropdowns.teams.getSelectedValues();
      const set = new Set(userIds);
      if(teamIds.length){
        await ensureTeamMembersLoaded(teamIds);
        teamIds.forEach(tid=>{
          (state.teamMembers.get(tid)||[]).forEach(uid=>set.add(uid));
        });
      }
      return Array.from(set);
    }

    async function agentsForTeams(teamIds){
      await ensureTeamMembersLoaded(teamIds);
      const ids=new Set();
      teamIds.forEach(tid=>(state.teamMembers.get(tid)||[]).forEach(id=>ids.add(id)));
      return Array.from(ids);
    }

    // ===== Main survey loading =====
    async function loadSurveys(){
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const ratingFilter = document.getElementById('ratingFilter').value;
      
      if(!fromDate || !toDate){
        msg('Please select both From and To dates.','error');
        return;
      }
      
      const agentIds = await computeSelectedAgentIds();
      const start = new Date(fromDate + 'T00:00:00');
      const end = new Date(toDate + 'T23:59:59');
      
      const btn=document.getElementById('loadBtn'); 
      setLoading(btn,true); 
      msg('Loading surveys...','info');
      
      try{
        // First, get conversations for the date range
        state.conversations = await fetchConversations(start, end, agentIds);
        console.log(`Found ${state.conversations.length} conversations`);
        
        // Then, get surveys for these conversations
        state.surveys = await fetchSurveysForConversations(state.conversations);
        console.log(`Found ${state.surveys.length} surveys`);
        
        // Apply rating filter
        if(ratingFilter !== 'all'){
          state.surveys = state.surveys.filter(s => {
            if(ratingFilter === 'nps-promoter'){
              const score = getSurveyScore(s);
              return score >= 9 && score <= 10;
            } else if(ratingFilter === 'nps-passive'){
              const score = getSurveyScore(s);
              return score >= 7 && score <= 8;
            } else if(ratingFilter === 'nps-detractor'){
              const score = getSurveyScore(s);
              return score >= 0 && score <= 6;
            } else {
              const score = getSurveyScore(s);
              return Math.round(score) === parseInt(ratingFilter);
            }
          });
        }
        
        msg(`Loaded ${state.surveys.length} surveys.`,'success');
        renderOverview();
        renderSurveyDetails();
      } catch(e){ 
        console.error(e); 
        msg('Failed to load surveys: '+e.message,'error'); 
      } finally{ 
        setLoading(btn,false); 
      }
    }

    async function fetchConversations(start, end, agentIds){
      const url = `https://api.${config.REGION}/api/v2/analytics/conversations/aggregates/query`;
      
      const body = {
        "interval": `${start.toISOString()}/${end.toISOString()}`,
        "granularity": "DAY",
        "groupBy": ["conversationId"],
        "metrics": ["nConversations"],
        "filter": {
          "type": "and",
          "clauses": []
        }
      };
      
      // Add agent filter if agents are selected
      if(agentIds && agentIds.length > 0){
        body.filter.clauses.push({
          "type": "or",
          "predicates": agentIds.map(agentId => ({
            "dimension": "participantId",
            "value": agentId
          }))
        });
      }
      
      try {
        const data = await fetchJsonWithRetry(url, {
          method: 'POST',
          body: JSON.stringify(body)
        });
        
        // Extract conversation IDs from results
        const conversations = [];
        if(data && data.results && data.results.length > 0){
          data.results.forEach(result => {
            if(result.group && result.group.conversationId){
              conversations.push({
                conversationId: result.group.conversationId
              });
            }
          });
        }
        
        return conversations;
      } catch (error) {
        console.error('Error fetching conversations:', error);
        throw error;
      }
    }

    async function fetchSurveysForConversations(conversations){
      if(!conversations || conversations.length === 0) return [];
      
      const url = `https://api.${config.REGION}/api/v2/analytics/surveys/aggregates/query`;
      
      // Process in batches of 50 conversations to avoid too large requests
      const batchSize = 50;
      const batches = [];
      for(let i = 0; i < conversations.length; i += batchSize){
        batches.push(conversations.slice(i, i + batchSize));
      }
      
      const allSurveys = [];
      
      for(const batch of batches){
        const conversationIds = batch.map(c => c.conversationId);
        
        const body = {
          "interval": "1900-01-01T00:00:00/2100-01-01T00:00:00", // Wide interval to get all surveys
          "granularity": "DAY",
          "groupBy": ["conversationId", "surveyId", "surveyQuestionGroupId", "surveyQuestionId"],
          "metrics": ["nSurveys", "npsScore", "npsPromoterCount", "npsDetractorCount"],
          "filter": {
            "type": "and",
            "clauses": [{
              "type": "or",
              "predicates": conversationIds.map(conversationId => ({
                "dimension": "conversationId",
                "value": conversationId
              }))
            }]
          }
        };
        
        try {
          const data = await fetchJsonWithRetry(url, {
            method: 'POST',
            body: JSON.stringify(body)
          });
          
          if(data && data.results && data.results.length > 0){
            // Process survey results
            const surveyMap = new Map();
            
            data.results.forEach(result => {
              const conversationId = result.group.conversationId;
              const surveyId = result.group.surveyId;
              const questionGroupId = result.group.surveyQuestionGroupId;
              const questionId = result.group.surveyQuestionId;
              
              const key = `${conversationId}_${surveyId}`;
              
              if(!surveyMap.has(key)){
                surveyMap.set(key, {
                  conversationId: conversationId,
                  surveyId: surveyId,
                  npsScore: result.data[0]?.stats?.npsScore || 0,
                  npsPromoterCount: result.data[0]?.stats?.npsPromoterCount || 0,
                  npsDetractorCount: result.data[0]?.stats?.npsDetractorCount || 0,
                  questions: []
                });
              }
              
              const survey = surveyMap.get(key);
              
              // Get the actual question and answer data
              // This would need additional API calls to get the full survey response
              // For now, we'll structure what we have
              if(questionId && questionGroupId){
                survey.questions.push({
                  questionGroupId: questionGroupId,
                  questionId: questionId,
                  score: result.data[0]?.stats?.npsScore || 0
                });
              }
            });
            
            // Convert map to array
            const batchSurveys = Array.from(surveyMap.values());
            allSurveys.push(...batchSurveys);
          }
        } catch (error) {
          console.error('Error fetching surveys batch:', error);
          // Continue with next batch
        }
        
        // Add a small delay between batches to avoid rate limiting
        await sleep(500);
      }
      
      // Now enrich with conversation details and agent information
      const enrichedSurveys = await Promise.all(allSurveys.map(async (survey) => {
        try {
          // Get conversation details to find agent
          const convUrl = `https://api.${config.REGION}/api/v2/analytics/conversations/details/query`;
          const convBody = {
            "order": "asc",
            "orderBy": "conversationStart",
            "paging": {
              "pageSize": 1,
              "pageNumber": 1
            },
            "segmentFilters": [{
              "type": "and",
              "predicates": [{
                "dimension": "conversationId",
                "value": survey.conversationId
              }]
            }]
          };
          
          const convData = await fetchJsonWithRetry(convUrl, {
            method: 'POST',
            body: JSON.stringify(convBody)
          });
          
          if(convData && convData.conversations && convData.conversations.length > 0){
            const conversation = convData.conversations[0];
            const participants = conversation.participants || [];
            
            // Find the agent participant
            const agentParticipant = participants.find(p => 
              p.purpose === 'agent' || p.purpose === 'acd' || 
              (p.user && p.user.id)
            );
            
            // Find the customer participant for contact info
            const customerParticipant = participants.find(p => 
              p.purpose === 'customer' || p.purpose === 'external'
            );
            
            return {
              ...survey,
              conversationStart: conversation.conversationStart,
              conversationEnd: conversation.conversationEnd,
              mediaType: conversation.mediaType || 'Unknown',
              agentId: agentParticipant?.user?.id || null,
              agentName: agentParticipant?.user?.name || 'Unknown Agent',
              customerInfo: customerParticipant ? {
                name: customerParticipant.name,
                address: customerParticipant.address,
                phone: customerParticipant.phone
              } : null,
              // Try to get free text responses if available
              comments: [] // This would need additional API calls
            };
          }
        } catch (error) {
          console.error('Error enriching survey:', error);
        }
        
        return {
          ...survey,
          conversationStart: null,
          conversationEnd: null,
          mediaType: 'Unknown',
          agentId: null,
          agentName: 'Unknown Agent',
          customerInfo: null,
          comments: []
        };
      }));
      
      return enrichedSurveys;
    }

    function getSurveyScore(survey){
      // Return NPS score or calculate from available data
      return survey.npsScore || 0;
    }

    function getRatingLabel(score){
      if(score >= 9) return {label: 'Promoter', class: 'excellent', badge: 'badge-excellent'};
      if(score >= 7) return {label: 'Passive', class: 'good', badge: 'badge-good'};
      if(score >= 5) return {label: 'Fair', class: 'fair', badge: 'badge-fair'};
      if(score >= 3) return {label: 'Poor', class: 'poor', badge: 'badge-poor'};
      return {label: 'Detractor', class: 'very-poor', badge: 'badge-very-poor'};
    }

    function getRatingColor(score){
      if(score >= 9) return COLORS.RATING_5;
      if(score >= 7) return COLORS.RATING_4;
      if(score >= 5) return COLORS.RATING_3;
      if(score >= 3) return COLORS.RATING_2;
      return COLORS.RATING_1;
    }

    // ===== Renderers =====
    function renderOverview(){
      if(!state.surveys || state.surveys.length === 0){
        document.getElementById('ratingSummary').innerHTML = '<div class="muted">No survey data available.</div>';
        document.getElementById('statsGrid').innerHTML = '';
        document.getElementById('surveysTable').innerHTML = '<tr><td class="muted">No surveys loaded.</td></tr>';
        return;
      }
      
      // Calculate rating distribution
      const ratingCounts = {5:0,4:0,3:0,2:0,1:0};
      const promoterCounts = {promoters:0, passives:0, detractors:0};
      let totalScore = 0;
      let totalSurveys = state.surveys.length;
      
      state.surveys.forEach(survey => {
        const score = getSurveyScore(survey);
        const roundedScore = Math.round(score);
        if(roundedScore >= 1 && roundedScore <= 5){
          ratingCounts[roundedScore]++;
        }
        totalScore += score;
        
        // NPS categorization
        if(score >= 9) promoterCounts.promoters++;
        else if(score >= 7) promoterCounts.passives++;
        else if(score >= 0) promoterCounts.detractors++;
      });
      
      const averageScore = totalSurveys > 0 ? totalScore / totalSurveys : 0;
      const npsScore = promoterCounts.promoters - promoterCounts.detractors;
      const responseRate = state.conversations.length > 0 ? (totalSurveys / state.conversations.length) * 100 : 0;
      
      // Render rating summary
      const ratingSummary = document.getElementById('ratingSummary');
      ratingSummary.innerHTML = `
        <div class="rating-item">
          <div class="count" style="color:#22c55e">${ratingCounts[5]}</div>
          <div class="label">Excellent (5)</div>
        </div>
        <div class="rating-item">
          <div class="count" style="color:#86efac">${ratingCounts[4]}</div>
          <div class="label">Good (4)</div>
        </div>
        <div class="rating-item">
          <div class="count" style="color:#f59e0b">${ratingCounts[3]}</div>
          <div class="label">Fair (3)</div>
        </div>
        <div class="rating-item">
          <div class="count" style="color:#fdba74">${ratingCounts[2]}</div>
          <div class="label">Poor (2)</div>
        </div>
        <div class="rating-item">
          <div class="count" style="color:#ef4444">${ratingCounts[1]}</div>
          <div class="label">Very Poor (1)</div>
        </div>
      `;
      
      // Render stats grid
      const statsGrid = document.getElementById('statsGrid');
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="value">${averageScore.toFixed(1)}</div>
          <div class="label">Average Score</div>
        </div>
        <div class="stat-card">
          <div class="value">${npsScore}</div>
          <div class="label">Net Promoter Score</div>
          <div class="trend ${npsScore > 0 ? 'trend-up' : npsScore < 0 ? 'trend-down' : 'trend-neutral'}">
            ${npsScore > 0 ? '+' : ''}${npsScore} 
            (${promoterCounts.promoters}P, ${promoterCounts.passives}N, ${promoterCounts.detractors}D)
          </div>
        </div>
        <div class="stat-card">
          <div class="value">${responseRate.toFixed(1)}%</div>
          <div class="label">Response Rate</div>
          <div class="trend">${totalSurveys} of ${state.conversations.length} conversations</div>
        </div>
        <div class="stat-card">
          <div class="value">${((promoterCounts.promoters / totalSurveys) * 100).toFixed(1)}%</div>
          <div class="label">Promoter Rate</div>
        </div>
      `;
      
      // Render surveys table
      const surveysTable = document.getElementById('surveysTable');
      const rows = state.surveys.slice(0, 50).map(survey => {
        const score = getSurveyScore(survey);
        const rating = getRatingLabel(score);
        const date = survey.conversationStart ? toDateTime(survey.conversationStart) : 'Unknown date';
        
        return `
          <tr>
            <td>${date}</td>
            <td>${survey.agentName}</td>
            <td>
              <span class="rating-indicator rating-${Math.round(score)}"></span>
              <span class="badge ${rating.badge}">${score.toFixed(1)} - ${rating.label}</span>
            </td>
            <td>${survey.mediaType}</td>
            <td>${survey.customerInfo?.phone || survey.customerInfo?.address || 'No contact info'}</td>
          </tr>
        `;
      }).join('');
      
      surveysTable.innerHTML = `
        <thead>
          <tr>
            <th>Date</th>
            <th>Agent</th>
            <th>Rating</th>
            <th>Media Type</th>
            <th>Contact Info</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
          ${state.surveys.length > 50 ? `<tr><td colspan="5" class="muted">Showing 50 of ${state.surveys.length} surveys</td></tr>` : ''}
        </tbody>
      `;
    }

    function applyDetailsFilters(){
      state.detailsAgentFilter = document.getElementById('detailsAgentFilter').value;
      state.detailsRatingFilter = document.getElementById('detailsRatingFilter').value;
      renderSurveyDetails();
    }

    function renderSurveyDetails(){
      const container = document.getElementById('surveysContainer');
      
      if(!state.surveys || state.surveys.length === 0){
        container.innerHTML = '<div class="muted">No survey data available.</div>';
        return;
      }
      
      // Apply filters
      let filteredSurveys = state.surveys;
      
      if(state.detailsAgentFilter !== 'all'){
        filteredSurveys = filteredSurveys.filter(s => s.agentName === state.detailsAgentFilter);
      }
      
      if(state.detailsRatingFilter !== 'all'){
        filteredSurveys = filteredSurveys.filter(s => {
          const score = getSurveyScore(s);
          return Math.round(score) === parseInt(state.detailsRatingFilter);
        });
      }
      
      // Update agent filter dropdown
      const uniqueAgents = [...new Set(state.surveys.map(s => s.agentName))].sort();
      const agentFilter = document.getElementById('detailsAgentFilter');
      agentFilter.innerHTML = '<option value="all">All Agents</option>' + 
        uniqueAgents.map(agent => `<option value="${agent}" ${state.detailsAgentFilter === agent ? 'selected' : ''}>${agent}</option>`).join('');
      
      // Render surveys
      if(filteredSurveys.length === 0){
        container.innerHTML = '<div class="muted">No surveys match the selected filters.</div>';
        return;
      }
      
      const surveysHtml = filteredSurveys.map(survey => {
        const score = getSurveyScore(survey);
        const rating = getRatingLabel(score);
        const date = survey.conversationStart ? toDateTime(survey.conversationStart) : 'Unknown date';
        const color = getRatingColor(score);
        
        let customerInfo = '';
        if(survey.customerInfo){
          if(survey.customerInfo.phone) customerInfo += `<div class="contact-info">Phone: ${survey.customerInfo.phone}</div>`;
          if(survey.customerInfo.address) customerInfo += `<div class="contact-info">Contact: ${survey.customerInfo.address}</div>`;
        }
        
        let questionDetails = '';
        if(survey.questions && survey.questions.length > 0){
          questionDetails = survey.questions.map(q => `
            <div style="margin-top:8px; padding-left:8px; border-left:2px solid ${COLORS.PRIMARY}">
              <div><strong>Question:</strong> Survey question ${q.questionId}</div>
              <div><strong>Score:</strong> ${q.score || 'N/A'}</div>
            </div>
          `).join('');
        }
        
        return `
          <div class="survey-card rating-${Math.round(score)}" style="border-left-color:${color}">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong>${survey.agentName}</strong>
                <div class="contact-info">${date} â€¢ ${survey.mediaType}</div>
                ${customerInfo}
              </div>
              <div style="text-align:right">
                <div style="font-size:24px;font-weight:bold;color:${color}">${score.toFixed(1)}</div>
                <span class="badge ${rating.badge}">${rating.label}</span>
              </div>
            </div>
            ${questionDetails}
            ${survey.comments && survey.comments.length > 0 ? `
              <div style="margin-top:12px">
                <strong>Comments:</strong>
                ${survey.comments.map(c => `<div class="comment-bubble">${c}</div>`).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      container.innerHTML = `
        <div class="muted" style="margin-bottom:12px">Showing ${filteredSurveys.length} of ${state.surveys.length} surveys</div>
        ${surveysHtml}
      `;
    }

    async function loadAnalytics(){
      const fromDate = document.getElementById('anaFromDate').value;
      const toDate = document.getElementById('anaToDate').value;
      
      if(!fromDate || !toDate){
        msg('Please select both From and To dates.','error');
        return;
      }
      
      const btn=document.getElementById('loadAnalyticsBtn'); 
      setLoading(btn,true); 
      msg('Loading analytics...','info');
      
      try{
        // Similar to loadSurveys but for analytics tab
        const start = new Date(fromDate + 'T00:00:00');
        const end = new Date(toDate + 'T23:59:59');
        
        const agentIds = await computeSelectedAgentIds();
        const teamFilter = dropdowns.analyticsTeams.getSelectedValues();
        let allowedAgents = null;
        if(teamFilter.length){ 
          allowedAgents = new Set(await agentsForTeams(teamFilter)); 
        }
        
        // Load conversations and surveys
        const conversations = await fetchConversations(start, end, agentIds);
        const surveys = await fetchSurveysForConversations(conversations);
        
        // Apply team filter
        const filteredSurveys = allowedAgents ? 
          surveys.filter(s => allowedAgents.has(s.agentId)) : 
          surveys;
        
        renderAnalyticsCharts(filteredSurveys);
        msg(`Analytics loaded: ${filteredSurveys.length} surveys.`,'success');
      } catch(e){ 
        console.error(e); 
        msg('Failed to load analytics: '+e.message,'error'); 
      } finally{ 
        setLoading(btn,false); 
      }
    }

    function renderAnalyticsCharts(surveys){
      const container = document.getElementById('analyticsCharts');
      
      if(!surveys || surveys.length === 0){
        container.innerHTML = '<div class="muted">No survey data available for analytics.</div>';
        return;
      }
      
      // Calculate data for charts
      const ratingDistribution = {5:0,4:0,3:0,2:0,1:0};
      const agentPerformance = new Map();
      const mediaTypePerformance = new Map();
      const dailyTrends = new Map();
      
      surveys.forEach(survey => {
        const score = getSurveyScore(survey);
        const roundedScore = Math.round(score);
        
        if(roundedScore >= 1 && roundedScore <= 5){
          ratingDistribution[roundedScore]++;
        }
        
        // Agent performance
        if(!agentPerformance.has(survey.agentName)){
          agentPerformance.set(survey.agentName, {count:0, sum:0});
        }
        const agentData = agentPerformance.get(survey.agentName);
        agentData.count++;
        agentData.sum += score;
        
        // Media type performance
        if(!mediaTypePerformance.has(survey.mediaType)){
          mediaTypePerformance.set(survey.mediaType, {count:0, sum:0});
        }
        const mediaData = mediaTypePerformance.get(survey.mediaType);
        mediaData.count++;
        mediaData.sum += score;
        
        // Daily trends
        if(survey.conversationStart){
          const date = new Date(survey.conversationStart).toISOString().split('T')[0];
          if(!dailyTrends.has(date)){
            dailyTrends.set(date, {count:0, sum:0});
          }
          const trendData = dailyTrends.get(date);
          trendData.count++;
          trendData.sum += score;
        }
      });
      
      // Create charts
      container.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:16px">
          <div class="card">
            <h3 class="section-title">Rating Distribution</h3>
            <div style="height:300px">
              <canvas id="ratingDistributionChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="section-title">Daily Trend</h3>
            <div style="height:300px">
              <canvas id="dailyTrendChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="section-title">Top Agents by Score</h3>
            <div style="height:300px">
              <canvas id="agentPerformanceChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="section-title">Performance by Media Type</h3>
            <div style="height:300px">
              <canvas id="mediaPerformanceChart"></canvas>
            </div>
          </div>
        </div>
      `;
      
      // Rating Distribution Chart
      const ratingCtx = document.getElementById('ratingDistributionChart').getContext('2d');
      new Chart(ratingCtx, {
        type: 'bar',
        data: {
          labels: ['Very Poor (1)', 'Poor (2)', 'Fair (3)', 'Good (4)', 'Excellent (5)'],
          datasets: [{
            label: 'Number of Surveys',
            data: [ratingDistribution[1], ratingDistribution[2], ratingDistribution[3], ratingDistribution[4], ratingDistribution[5]],
            backgroundColor: [COLORS.RATING_1, COLORS.RATING_2, COLORS.RATING_3, COLORS.RATING_4, COLORS.RATING_5],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Count'
              }
            }
          }
        }
      });
      
      // Daily Trend Chart
      const sortedDates = Array.from(dailyTrends.keys()).sort();
      const dailyAvgScores = sortedDates.map(date => {
        const data = dailyTrends.get(date);
        return data.count > 0 ? data.sum / data.count : 0;
      });
      
      const trendCtx = document.getElementById('dailyTrendChart').getContext('2d');
      new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: sortedDates.map(d => new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })),
          datasets: [{
            label: 'Average Score',
            data: dailyAvgScores,
            borderColor: COLORS.PRIMARY,
            backgroundColor: COLORS.PRIMARY + '20',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              min: 0,
              max: 10,
              title: {
                display: true,
                text: 'Average Score'
              }
            }
          }
        }
      });
      
      // Agent Performance Chart
      const topAgents = Array.from(agentPerformance.entries())
        .map(([name, data]) => ({name, avg: data.count > 0 ? data.sum / data.count : 0, count: data.count}))
        .filter(a => a.count >= 3) // Only show agents with at least 3 surveys
        .sort((a, b) => b.avg - a.avg)
        .slice(0, 10);
      
      const agentCtx = document.getElementById('agentPerformanceChart').getContext('2d');
      new Chart(agentCtx, {
        type: 'bar',
        data: {
          labels: topAgents.map(a => a.name),
          datasets: [{
            label: 'Average Score',
            data: topAgents.map(a => a.avg),
            backgroundColor: topAgents.map(a => getRatingColor(a.avg)),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          scales: {
            x: {
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'Average Score'
              }
            }
          }
        }
      });
      
      // Media Performance Chart
      const mediaTypes = Array.from(mediaTypePerformance.entries())
        .map(([name, data]) => ({name, avg: data.count > 0 ? data.sum / data.count : 0, count: data.count}))
        .filter(m => m.count >= 3);
      
      const mediaCtx = document.getElementById('mediaPerformanceChart').getContext('2d');
      new Chart(mediaCtx, {
        type: 'bar',
        data: {
          labels: mediaTypes.map(m => m.name),
          datasets: [{
            label: 'Average Score',
            data: mediaTypes.map(m => m.avg),
            backgroundColor: mediaTypes.map(m => getRatingColor(m.avg)),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'Average Score'
              }
            }
          }
        }
      });
    }

    async function loadTrends(){
      const fromDate = document.getElementById('trendFromDate').value;
      const toDate = document.getElementById('trendToDate').value;
      const period = document.getElementById('trendPeriod').value;
      
      if(!fromDate || !toDate){
        msg('Please select both From and To dates.','error');
        return;
      }
      
      const btn=document.getElementById('loadTrendsBtn'); 
      setLoading(btn,true); 
      msg('Loading trends...','info');
      
      try{
        const start = new Date(fromDate + 'T00:00:00');
        const end = new Date(toDate + 'T23:59:59');
        
        const agentIds = await computeSelectedAgentIds();
        const conversations = await fetchConversations(start, end, agentIds);
        const surveys = await fetchSurveysForConversations(conversations);
        
        renderTrendsCharts(surveys, period);
        msg(`Trends loaded: ${surveys.length} surveys.`,'success');
      } catch(e){ 
        console.error(e); 
        msg('Failed to load trends: '+e.message,'error'); 
      } finally{ 
        setLoading(btn,false); 
      }
    }

    function renderTrendsCharts(surveys, period){
      const container = document.getElementById('trendsCharts');
      
      if(!surveys || surveys.length === 0){
        container.innerHTML = '<div class="muted">No survey data available for trends.</div>';
        return;
      }
      
      // Group by period
      const periodData = new Map();
      
      surveys.forEach(survey => {
        if(survey.conversationStart){
          const date = new Date(survey.conversationStart);
          let periodKey;
          
          switch(period){
            case 'week':
              const weekYear = date.getFullYear();
              const weekNumber = getWeekNumber(date);
              periodKey = `${weekYear}-W${String(weekNumber).padStart(2, '0')}`;
              break;
            case 'month':
              periodKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
              break;
            default: // day
              periodKey = date.toISOString().split('T')[0];
          }
          
          if(!periodData.has(periodKey)){
            periodData.set(periodKey, {count:0, sum:0, promoters:0, passives:0, detractors:0});
          }
          
          const data = periodData.get(periodKey);
          data.count++;
          data.sum += getSurveyScore(survey);
          
          const score = getSurveyScore(survey);
          if(score >= 9) data.promoters++;
          else if(score >= 7) data.passives++;
          else if(score >= 0) data.detractors++;
        }
      });
      
      // Sort periods
      const sortedPeriods = Array.from(periodData.keys()).sort();
      
      container.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:16px">
          <div class="card">
            <h3 class="section-title">Average Score Trend</h3>
            <div style="height:300px">
              <canvas id="scoreTrendChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="section-title">NPS Trend</h3>
            <div style="height:300px">
              <canvas id="npsTrendChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="section-title">Volume Trend</h3>
            <div style="height:300px">
              <canvas id="volumeTrendChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="section-title">Rating Distribution Trend</h3>
            <div style="height:300px">
              <canvas id="distributionTrendChart"></canvas>
            </div>
          </div>
        </div>
      `;
      
      // Format period labels
      const periodLabels = sortedPeriods.map(p => {
        if(period === 'week'){
          const [year, week] = p.split('-W');
          return `Week ${week}, ${year}`;
        } else if(period === 'month'){
          const [year, month] = p.split('-');
          const date = new Date(year, month - 1, 1);
          return date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
        } else {
          return new Date(p).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }
      });
      
      // Score Trend Chart
      const scoreTrendData = sortedPeriods.map(p => {
        const data = periodData.get(p);
        return data.count > 0 ? data.sum / data.count : 0;
      });
      
      const scoreCtx = document.getElementById('scoreTrendChart').getContext('2d');
      new Chart(scoreCtx, {
        type: 'line',
        data: {
          labels: periodLabels,
          datasets: [{
            label: 'Average Score',
            data: scoreTrendData,
            borderColor: COLORS.PRIMARY,
            backgroundColor: COLORS.PRIMARY + '20',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              min: 0,
              max: 10,
              title: {
                display: true,
                text: 'Average Score'
              }
            }
          }
        }
      });
      
      // NPS Trend Chart
      const npsTrendData = sortedPeriods.map(p => {
        const data = periodData.get(p);
        return data.promoters - data.detractors;
      });
      
      const npsCtx = document.getElementById('npsTrendChart').getContext('2d');
      new Chart(npsCtx, {
        type: 'line',
        data: {
          labels: periodLabels,
          datasets: [{
            label: 'Net Promoter Score',
            data: npsTrendData,
            borderColor: COLORS.BLUE,
            backgroundColor: COLORS.BLUE + '20',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              title: {
                display: true,
                text: 'NPS'
              }
            }
          }
        }
      });
      
      // Volume Trend Chart
      const volumeData = sortedPeriods.map(p => periodData.get(p).count);
      
      const volumeCtx = document.getElementById('volumeTrendChart').getContext('2d');
      new Chart(volumeCtx, {
        type: 'bar',
        data: {
          labels: periodLabels,
          datasets: [{
            label: 'Survey Volume',
            data: volumeData,
            backgroundColor: COLORS.SECONDARY,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Surveys'
              }
            }
          }
        }
      });
      
      // Distribution Trend Chart
      // This is a stacked area chart showing promoter/passive/detractor trends
      const promoterData = sortedPeriods.map(p => periodData.get(p).promoters);
      const passiveData = sortedPeriods.map(p => periodData.get(p).passives);
      const detractorData = sortedPeriods.map(p => periodData.get(p).detractors);
      
      const distributionCtx = document.getElementById('distributionTrendChart').getContext('2d');
      new Chart(distributionCtx, {
        type: 'line',
        data: {
          labels: periodLabels,
          datasets: [
            {
              label: 'Promoters',
              data: promoterData,
              borderColor: COLORS.RATING_5,
              backgroundColor: COLORS.RATING_5 + '20',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            },
            {
              label: 'Passives',
              data: passiveData,
              borderColor: COLORS.RATING_4,
              backgroundColor: COLORS.RATING_4 + '20',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            },
            {
              label: 'Detractors',
              data: detractorData,
              borderColor: COLORS.RATING_1,
              backgroundColor: COLORS.RATING_1 + '20',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              stacked: true,
              beginAtZero: true,
              title: {
                display: true,
                text: 'Count'
              }
            }
          }
        }
      });
    }

    function getWeekNumber(d) {
      const date = new Date(d);
      date.setHours(0, 0, 0, 0);
      date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
      const week1 = new Date(date.getFullYear(), 0, 4);
      return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }
  </script>
</body>
</html>
